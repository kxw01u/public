<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board v30</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%232563eb'><rect x='10' y='10' width='20' height='80' rx='5'/><rect x='40' y='10' width='20' height='80' rx='5'/><rect x='70' y='10' width='20' height='80' rx='5'/></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* Hide scrollbar for color picker but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Dark Mode Overrides */
        .dark body, .dark .bg-gray-50 { background-color: #111827 !important; color: #e5e7eb; }
        .dark .bg-white { background-color: #1f2937 !important; border-color: #374151 !important; color: #e5e7eb; }
        .dark .bg-white\/60 { background-color: rgba(31, 41, 55, 0.6) !important; }
        .dark .bg-white\/40 { background-color: rgba(31, 41, 55, 0.4) !important; }
        .dark .text-gray-900 { color: #f9fafb !important; }
        .dark .text-gray-800 { color: #f3f4f6 !important; }
        .dark .text-gray-700 { color: #e5e7eb !important; }
        .dark .text-gray-600 { color: #d1d5db !important; }
        .dark .text-gray-500 { color: #9ca3af !important; }
        .dark .text-gray-400 { color: #6b7280 !important; }
        .dark .border-gray-200 { border-color: #374151 !important; }
        .dark .border-gray-100 { border-color: #374151 !important; }
        .dark input, .dark textarea, .dark select {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #fff !important;
        }
        .dark .hover\:bg-gray-100:hover { background-color: #374151 !important; }
        .dark .hover\:bg-gray-200\/50:hover { background-color: #374151 !important; }
        .dark .bg-gray-100 { background-color: #374151 !important; border-color: #4b5563; }

        /* Color input styling */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            padding: 0;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }
        .widget-drag-handle {
            cursor: grab;
        }
        .widget-drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import {
            LayoutDashboard,
            FolderKanban,
            Plus,
            Search,
            X,
            Check,
            RotateCcw,
            Trash2,
            Calendar,
            Clock,
            User,
            Briefcase,
            Layers,
            KanbanSquare,
            Palette,
            CheckCircle2,
            TrendingUp,
            Activity,
            PieChart,
            ArrowRight,
            ArrowLeft,
            CornerDownRight,
            Circle,
            Download,
            Upload,
            AlertCircle,
            ExternalLink,
            Sparkles,
            AlignLeft,
            GripVertical,
            ChevronDown,
            ChevronRight,
            Maximize2,
            Minimize2,
            Save,
            Settings,
            Box, Flag, Star, Target, Zap, Globe, Cpu, Gift, Rocket, Award, Move
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Utility Functions ---

        const generateId = () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        const formatDate = (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';

        if (dateString.includes('-') && dateString.length === 10) {
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const localDate = new Date(parts[0], parts[1] - 1, parts[2]);
                return localDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
            }
        }
        return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
        };

        const calculateAge = (dateString) => {
        if (!dateString) return 0;
        const created = new Date(dateString);
        if (isNaN(created.getTime())) return 0;
        const now = new Date();
        const diffTime = Math.abs(now - created);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
        };

        const getEndFromEffort = (start, effort) => {
        if (!start || !effort) return '';
        const date = new Date(start);
        if (isNaN(date.getTime())) return '';

        if (effort.includes('d')) date.setDate(date.getDate() + parseInt(effort));
        else if (effort.includes('w')) date.setDate(date.getDate() + (parseInt(effort) * 7));
        else if (effort.includes('m')) date.setMonth(date.getMonth() + parseInt(effort));
        else date.setDate(date.getDate() + 1);

        return date.toISOString().split('T')[0];
        };

        const isDateInCurrentWeek = (dateString) => {
        if (!dateString) return false;
        let d;
        if (dateString.length === 10 && dateString.includes('-')) {
            const [y, m, day] = dateString.split('-').map(Number);
            d = new Date(y, m - 1, day);
        } else {
            d = new Date(dateString);
        }
        if (isNaN(d.getTime())) return false;
        d.setHours(0,0,0,0);
        const today = new Date();
        today.setHours(0,0,0,0);
        const dayOfWeek = today.getDay();
        const diffToSun = dayOfWeek;
        const sunday = new Date(today);
        sunday.setDate(today.getDate() - diffToSun);
        sunday.setHours(0,0,0,0);
        const saturday = new Date(sunday);
        saturday.setDate(sunday.getDate() + 6);
        saturday.setHours(23,59,59,999);
        return d >= sunday && d <= saturday;
        };

        const isDateInLastWeek = (dateString) => {
            if (!dateString) return false;
            let d;
            if (dateString.length === 10 && dateString.includes('-')) {
                const [y, m, day] = dateString.split('-').map(Number);
                d = new Date(y, m - 1, day);
            } else {
                d = new Date(dateString);
            }
            if (isNaN(d.getTime())) return false;
            d.setHours(0,0,0,0);

            const today = new Date();
            today.setHours(0,0,0,0);
            const dayOfWeek = today.getDay();
            const diffToSun = dayOfWeek;
            const thisSunday = new Date(today);
            thisSunday.setDate(today.getDate() - diffToSun);

            const lastSunday = new Date(thisSunday);
            lastSunday.setDate(thisSunday.getDate() - 7);
            lastSunday.setHours(0,0,0,0);

            const lastSaturday = new Date(thisSunday);
            lastSaturday.setDate(thisSunday.getDate() - 1);
            lastSaturday.setHours(23,59,59,999);

            return d >= lastSunday && d <= lastSaturday;
        };

        const isTaskLeaf = (index, allTasks) => {
        if (index === allTasks.length - 1) return true;
        const currentLevel = allTasks[index].level || 0;
        const nextLevel = allTasks[index + 1].level || 0;
        return nextLevel <= currentLevel;
        };

        const hexToRgba = (hex, alpha) => {
            if (!hex) return `rgba(0,0,0,${alpha})`;

            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        };

        const getContrastColor = (hex) => {
            if (!hex) return '#000000';
            const color = (hex.charAt(0) === '#') ? hex.substring(1, 7) : hex;
            if (color.length !== 6) return '#000000'; 

            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        };

        const getWeekNumber = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        };

        // --- Constants ---

        const ICONS = {
            'FolderKanban': FolderKanban,
            'Briefcase': Briefcase,
            'Layers': Layers,
            'Box': Box,
            'Target': Target,
            'Zap': Zap,
            'Star': Star,
            'Cpu': Cpu,
            'Globe': Globe,
            'Flag': Flag
        };

        const DEFAULT_PRIORITY_CONFIG = {
            '1': { label: '1 - Urgent', color: '#ef4444' },
            '2': { label: '2 - High', color: '#8b5cf6' },
            '3': { label: '3 - Important', color: '#3b82f6' },
            '4': { label: '4 - Normal', color: '#10b981' },
        };

        const DEFAULT_WEIGHT_CONFIG = {
            'heavy': { label: 'Heavy', color: '#f97316' },
            'medium': { label: 'Medium', color: '#f59e0b' },
            'light': { label: 'Light', color: '#84cc16' },
        };

        const DEFAULT_PALETTE = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#64748b'
        ];

        const LEGACY_COLOR_MAP = {
            red: '#ef4444', orange: '#f97316', amber: '#f59e0b', yellow: '#eab308', lime: '#84cc16', green: '#22c55e', emerald: '#10b981', teal: '#14b8a6', cyan: '#06b6d4', sky: '#0ea5e9', blue: '#3b82f6', indigo: '#6366f1', violet: '#8b5cf6', purple: '#a855f7', fuchsia: '#d946ef', pink: '#ec4899', rose: '#f43f5e', slate: '#64748b', gray: '#6b7280', zinc: '#71717a', neutral: '#737373', stone: '#78716c',
        };

        const generateDynamicStyles = (config) => {
            const styles = {};
            Object.keys(config).forEach(key => {
                const item = config[key];
                const hex = item.color || '#000000';
                const contrastText = getContrastColor(hex);

                styles[key] = {
                    ...item,
                    styleObj: {
                        backgroundColor: hex,
                        color: contrastText,
                        borderColor: hex,
                        borderWidth: '1px'
                    },
                    dotStyle: { backgroundColor: contrastText },
                    solidStyle: { backgroundColor: hex }
                };
            });
            return styles;
        };

        // --- Sub-Components ---

        const GlobalColorPicker = ({ position, onSelect, onClose, palette }) => {
            return (
                <React.Fragment>
                <div
                    className="fixed inset-0 z-[9998]"
                    onMouseDown={(e) => { e.stopPropagation(); onClose(); }}
                    onClick={(e) => { e.stopPropagation(); onClose(); }}
                ></div>
                <div
                    className="fixed z-[9999] p-3 bg-white rounded-xl shadow-2xl border border-gray-200 grid grid-cols-5 gap-3 animate-in fade-in zoom-in-95 duration-100"
                    style={{
                        top: position.y + 10,
                        left: Math.min(position.x - 100, window.innerWidth - 320),
                    }}
                    onMouseDown={(e) => e.stopPropagation()}
                    onClick={(e) => e.stopPropagation()}
                >
                    {palette.map((color, index) => (
                        <button
                            key={index}
                            onMouseDown={(e) => e.stopPropagation()}
                            onClick={(e) => {
                                e.stopPropagation();
                                onSelect(index);
                                onClose();
                            }}
                            style={{ backgroundColor: color }}
                            className={`w-8 h-8 rounded-full hover:scale-110 transition-transform border border-gray-300 shadow-sm shrink-0 cursor-pointer ring-2 ring-transparent hover:ring-gray-300`}
                            title={`Color ${index + 1}`}
                        />
                    ))}
                </div>
                </React.Fragment>
            );
        };

        const DonutChart = ({ data, size = 120, showLegend = true }) => {
            let accumulatedAngle = 0;
            const total = data.reduce((acc, curr) => acc + curr.value, 0);

            if (total === 0) return (
                <div className={`flex items-center justify-center bg-gray-50 rounded-full mx-auto text-gray-400 text-xs`} style={{ width: size, height: size }}>
                No Data
                </div>
            );

            return (
                <div className={`flex ${showLegend ? 'items-center justify-center gap-6' : 'flex-col items-center'}`}>
                <div className="relative shrink-0" style={{ width: size, height: size }}>
                    <svg viewBox="0 0 100 100" className="w-full h-full">
                    {data.map((slice, index) => {
                        if (slice.value === 0) return null;
                        const percentage = slice.value / total;
                        const angle = percentage * 360;
                        const startAngle = -90 - accumulatedAngle;
                        const endAngle = startAngle - angle;
                        const r = 50; const cx = 50; const cy = 50;
                        const startX = cx + r * Math.cos((Math.PI * startAngle) / 180);
                        const startY = cy + r * Math.sin((Math.PI * startAngle) / 180);
                        const endX = cx + r * Math.cos((Math.PI * endAngle) / 180);
                        const endY = cy + r * Math.sin((Math.PI * endAngle) / 180);
                        const largeArcFlag = percentage > 0.5 ? 1 : 0;
                        const sweepFlag = 0;
                        accumulatedAngle += angle;
                        return (
                        <path
                            key={index}
                            d={`M ${cx} ${cy} L ${startX} ${startY} A ${r} ${r} 0 ${largeArcFlag} ${sweepFlag} ${endX} ${endY} Z`}
                            fill={slice.color}
                            stroke="white"
                            strokeWidth="1"
                        />
                        );
                    })}
                    <circle cx="50" cy="50" r="30" fill="white" />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center flex-col">
                    <span className="text-xl font-bold text-gray-700">{total}</span>
                    </div>
                </div>
                {showLegend && (
                    <div className="space-y-1">
                    {data.map((slice, index) => (
                        <div key={index} className="flex items-center gap-2 text-xs text-gray-600">
                        <div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: slice.color }}></div>
                        <span className="truncate max-w-[100px]" title={slice.label}>{slice.label}</span>
                        <span className="font-bold text-gray-400">({slice.value})</span>
                        </div>
                    ))}
                    </div>
                )}
                </div>
            );
        };

        const TimeChart = ({ tasks, settings }) => {
            const weightStyles = useMemo(() => generateDynamicStyles(settings.weightConfig), [settings.weightConfig]);
            
            // 1. Filter WIP Tasks
            const wipTasks = tasks.filter(t => t.status === 'wip');
            
            if (wipTasks.length === 0) {
                return <div className="text-center py-10 text-gray-400 italic">No ongoing tasks to display in timeline.</div>;
            }

            // 2. Determine Date Range (Last 2 weeks to Next 2 weeks)
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 14);
            const dayOfWeek = startDate.getDay(); // 0 is Sun
            const diffToMon = (dayOfWeek + 6) % 7; 
            startDate.setDate(startDate.getDate() - diffToMon); // Move to Monday
            startDate.setHours(0,0,0,0);

            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 21);
            const endDayOfWeek = endDate.getDay();
            const diffToSun = (7 - endDayOfWeek) % 7;
            endDate.setDate(endDate.getDate() + diffToSun);
            endDate.setHours(23,59,59,999);

            const totalDuration = endDate - startDate;

            const getPercent = (date) => {
                const d = new Date(date);
                if (d < startDate) return 0;
                if (d > endDate) return 100;
                return ((d - startDate) / totalDuration) * 100;
            };

            // 4. Group by Assignee and Resolve Overlaps
            const assignees = [...new Set(wipTasks.map(t => t.assignee || 'Unassigned'))].sort();
            
            const assigneeRows = assignees.map(assignee => {
                const userTasks = wipTasks.filter(t => (t.assignee || 'Unassigned') === assignee);
                userTasks.sort((a, b) => new Date(a.start) - new Date(b.start));

                const rows = [];
                const positionedTasks = userTasks.map(t => {
                    const taskStart = t.start ? new Date(t.start) : new Date();
                    // If no target date, extend to end of chart
                    const taskEnd = t.targetDate ? new Date(t.targetDate) : new Date(endDate);
                    if (taskEnd <= taskStart) taskEnd.setDate(taskStart.getDate() + 1);

                    let rowIndex = 0;
                    while (true) {
                        const row = rows[rowIndex] || [];
                        const hasOverlap = row.some(existing => {
                            return (taskStart < existing.end) && (taskEnd > existing.start);
                        });
                        
                        if (!hasOverlap) {
                            if (!rows[rowIndex]) rows[rowIndex] = [];
                            rows[rowIndex].push({ start: taskStart, end: taskEnd });
                            break;
                        }
                        rowIndex++;
                    }

                    return { ...t, rowIndex, calculatedEnd: taskEnd };
                });

                return {
                    name: assignee,
                    tasks: positionedTasks,
                    rowCount: rows.length || 1
                };
            });

            // 5. Generate Header Weeks
            const weeks = [];
            let curr = new Date(startDate);
            while (curr < endDate) {
                weeks.push({
                    label: `WK${getWeekNumber(curr)}`,
                    left: getPercent(curr),
                    width: (7 * 24 * 60 * 60 * 1000 / totalDuration) * 100
                });
                curr.setDate(curr.getDate() + 7);
            }

            const todayPercent = getPercent(today);

            return (
                <div className="overflow-x-auto">
                    <div className="min-w-[800px] relative pb-6 select-none">
                        {/* Header Weeks */}
                        <div className="h-8 border-b border-gray-200 relative mb-2 flex">
                            <div className="w-24 shrink-0"></div>
                            <div className="flex-1 relative h-full">
                                {weeks.map((w, i) => (
                                    <div key={i} className="absolute h-full border-l border-gray-200 text-[10px] font-bold text-gray-500 pl-1" style={{left: `${w.left}%`, width: `${w.width}%`}}>
                                        {w.label}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Today Line */}
                        {todayPercent > 0 && todayPercent < 100 && (
                            <div className="absolute top-8 bottom-0 w-0.5 bg-red-500 z-20 pointer-events-none" style={{left: `calc(96px + (100% - 96px) * ${todayPercent/100})`}}>
                                <div className="absolute -top-1 -left-1 w-2.5 h-2.5 rounded-full bg-red-600 shadow-sm"></div>
                            </div>
                        )}

                        {/* Rows */}
                        <div className="space-y-1">
                            {assigneeRows.map(row => (
                                <div key={row.name} className="flex border-b border-gray-100 last:border-0 pb-2 pt-2 group hover:bg-gray-50">
                                    <div className="w-24 shrink-0 text-xs font-bold text-gray-700 truncate pr-3 text-right pt-1" title={row.name}>{row.name}</div>
                                    <div className="flex-1 relative" style={{ height: `${Math.max(row.rowCount * 28, 28)}px` }}>
                                        {/* Background Grid */}
                                        <div className="absolute inset-0 w-full h-full">
                                            {weeks.map((w, i) => (
                                                <div key={i} className="absolute top-0 bottom-0 border-l border-gray-200" style={{left: `${w.left}%`}}></div>
                                            ))}
                                        </div>

                                        {/* Tasks */}
                                        {row.tasks.map(t => {
                                            const left = getPercent(t.start);
                                            let width = ((t.calculatedEnd - (t.start ? new Date(t.start) : startDate)) / totalDuration) * 100;
                                            
                                            if (left + width > 100) width = 100 - left;
                                            
                                            const isExtended = !t.targetDate;
                                            const wStyle = weightStyles[t.weight || 'light'] || weightStyles['light'];

                                            return (
                                                <div 
                                                    key={t.id}
                                                    className={`absolute h-6 rounded-md shadow-sm border border-black/10 flex items-center px-2 hover:ring-2 ring-blue-400 hover:z-10 transition-all cursor-pointer ${isExtended ? 'rounded-r-none border-r-2 border-r-gray-400/50 border-dashed' : ''}`}
                                                    style={{
                                                        left: `${left}%`,
                                                        width: `${Math.max(width, 0.5)}%`,
                                                        top: `${t.rowIndex * 28}px`,
                                                        backgroundColor: wStyle.styleObj.backgroundColor,
                                                        color: wStyle.styleObj.color
                                                    }}
                                                    title={`${t.name} (Start: ${formatDate(t.start)} - Target: ${t.targetDate ? formatDate(t.targetDate) : 'None'})`}
                                                >
                                                    <span className="text-[10px] font-medium truncate w-full leading-tight">
                                                        [{t.type || 'Task'}] {t.name}
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ settings, onUpdateSettings, onSaveConfig }) => {
            const handlePaletteChange = (index, newColor) => {
                const newPalette = [...settings.palette];
                newPalette[index] = newColor;
                onUpdateSettings('palette', newPalette);
            };

            const handleConfigColorChange = (type, key, newColor) => {
                const newConfig = { ...settings[type] };
                newConfig[key] = { ...newConfig[key], color: newColor };
                onUpdateSettings(type, newConfig);
            };

            return (
                <div className="p-8 max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <Activity size={20} className="text-blue-500"/> Display Settings
                            </h3>
                            <button
                                onClick={onSaveConfig}
                                className="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-md"
                                title="Save current settings and data to kanban.json"
                            >
                                <Save size={16} /> Save Setting
                            </button>
                        </div>

                        <div className="space-y-8">
                            {/* Theme & Palette */}
                            <div className="flex flex-col gap-4 pb-6 border-b border-gray-100">
                                <div className="flex justify-between items-center">
                                    <div className="font-semibold text-gray-700">Dark Theme</div>
                                    <button
                                        onClick={() => onUpdateSettings('darkMode', !settings.darkMode)}
                                        className={`w-12 h-6 rounded-full p-1 transition-colors ${settings.darkMode ? 'bg-blue-600' : 'bg-gray-300'}`}
                                    >
                                        <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${settings.darkMode ? 'translate-x-6' : 'translate-x-0'}`} />
                                    </button>
                                </div>

                                <div>
                                    <div className="font-semibold text-gray-700 mb-2">Color Palette</div>
                                    <div className="text-xs text-gray-500 mb-3">Customize the 10 colors used for Projects and Tasks. Click to change.</div>
                                    <div className="flex flex-row gap-4 items-center overflow-x-auto pb-2">
                                        {settings.palette.map((color, index) => (
                                            <div key={index} className="flex flex-col items-center gap-1 shrink-0">
                                                <div className="relative group">
                                                    <input
                                                        type="color"
                                                        value={color}
                                                        onChange={(e) => handlePaletteChange(index, e.target.value)}
                                                        className="w-8 h-8 rounded-full border-2 border-gray-200 cursor-pointer p-0"
                                                        title={`Palette #${index + 1}`}
                                                    />
                                                </div>
                                                <span className="text-[10px] text-gray-400 font-mono">#{index + 1}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* External Links Configuration */}
                            <div className="pb-6 border-b border-gray-100">
                                <div className="font-semibold text-gray-700 mb-3">External Links Configuration</div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Jira Path Base URL</label>
                                        <input
                                            type="text"
                                            className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50"
                                            placeholder="https://your-domain.atlassian.net/browse/"
                                            value={settings.jiraPath || ''}
                                            onChange={(e) => onUpdateSettings('jiraPath', e.target.value)}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Confluence Path Base URL</label>
                                        <input
                                            type="text"
                                            className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50"
                                            placeholder="https://your-domain.atlassian.net/wiki/spaces/"
                                            value={settings.confluencePath || ''}
                                            onChange={(e) => onUpdateSettings('confluencePath', e.target.value)}
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Priority Config */}
                            <div className="pb-6 border-b border-gray-100">
                                <div className="flex flex-wrap items-center gap-4">
                                    <div className="font-semibold text-gray-700 min-w-[100px]">Priority Colors</div>
                                    <div className="flex flex-row gap-6 items-center flex-wrap">
                                        {Object.entries(settings.priorityConfig).map(([key, config]) => (
                                            <div key={key} className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                                                <input
                                                    type="color"
                                                    value={config.color || '#000000'}
                                                    onChange={(e) => handleConfigColorChange('priorityConfig', key, e.target.value)}
                                                    className="w-6 h-6 rounded-full cursor-pointer border-none bg-transparent p-0"
                                                    title={`Change ${config.label} color`}
                                                />
                                                <span className="text-sm font-medium text-gray-700">{config.label}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Weight Config */}
                            <div className="pb-6 border-b border-gray-100">
                                <div className="font-semibold text-gray-700 mb-3">Weight Colors</div>
                                {/* 3. Single Line Weight */}
                                <div className="flex flex-row gap-6 items-center flex-wrap">
                                    {Object.entries(settings.weightConfig).map(([key, config]) => (
                                        <div key={key} className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                                            <input
                                                type="color"
                                                value={config.color || '#000000'}
                                                onChange={(e) => handleConfigColorChange('weightConfig', key, e.target.value)}
                                                className="w-6 h-6 rounded-full cursor-pointer border-none bg-transparent p-0"
                                                title={`Change ${config.label} color`}
                                            />
                                            <span className="text-sm font-medium text-gray-700">{config.label}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Warnings */}
                            <div className="flex flex-col gap-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex-1">
                                        <div className="font-semibold text-gray-700">Age Warning</div>
                                        <div className="text-xs text-gray-500">Red text if age &gt; (n) days</div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {settings.ageWarning.enabled && (
                                            <div className="flex items-center gap-1">
                                                <input
                                                    type="number"
                                                    className="w-16 p-1 border rounded text-center text-sm"
                                                    value={settings.ageWarning.days}
                                                    onChange={(e) => onUpdateSettings('ageWarning', { ...settings.ageWarning, days: parseInt(e.target.value) || 0 })}
                                                />
                                                <span className="text-xs text-gray-500">days</span>
                                            </div>
                                        )}
                                        <button
                                            onClick={() => onUpdateSettings('ageWarning', { ...settings.ageWarning, enabled: !settings.ageWarning.enabled })}
                                            className={`w-12 h-6 rounded-full p-1 transition-colors ${settings.ageWarning.enabled ? 'bg-blue-600' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${settings.ageWarning.enabled ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                </div>

                                <div className="flex items-center justify-between">
                                    <div className="flex-1">
                                        <div className="font-semibold text-gray-700">Deadline Warning</div>
                                        <div className="text-xs text-gray-500">Red text if target &lt; current + (n) days</div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {settings.deadlineWarning.enabled && (
                                            <div className="flex items-center gap-1">
                                                <input
                                                    type="number"
                                                    className="w-16 p-1 border rounded text-center text-sm"
                                                    value={settings.deadlineWarning.days}
                                                    onChange={(e) => onUpdateSettings('deadlineWarning', { ...settings.deadlineWarning, days: parseInt(e.target.value) || 0 })}
                                                />
                                                <span className="text-xs text-gray-500">days</span>
                                            </div>
                                        )}
                                        <button
                                            onClick={() => onUpdateSettings('deadlineWarning', { ...settings.deadlineWarning, enabled: !settings.deadlineWarning.enabled })}
                                            className={`w-12 h-6 rounded-full p-1 transition-colors ${settings.deadlineWarning.enabled ? 'bg-blue-600' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform ${settings.deadlineWarning.enabled ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ImportView = ({ onImport }) => {
            const [text, setText] = useState('');

            return (
                <div className="p-8 max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500 h-full flex flex-col">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex-1 flex flex-col">
                        <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                            <Upload size={20} className="text-blue-500"/> Import Tasks
                        </h3>
                        <p className="text-sm text-gray-500 mb-4">
                            Paste your <strong>exported CSV content</strong> or a JSON array below.
                            <br/><span className="text-xs text-gray-400">If a task has a matching UUID (ticketid), it will be skipped. New projects defined in CSV will be created automatically.</span>
                        </p>

                        <textarea
                            className="flex-1 w-full p-4 border border-gray-200 rounded-lg font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none resize-none mb-4 whitespace-pre"
                            placeholder={`UUID,Project,Task Name,Type,External Ref,Status,Priority,Weight,Assignee,Start Date,End Date,Created Date,Completed Date,Effort,Level,Description,Line Color\n"123-abc","Marketing","Launch Campaign","Task","JIRA-99","todo","1","heavy","Alice","2023-10-01",,,"",0,"Desc...","bg-blue-400"`}
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />

                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setText('')}
                                className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
                            >
                                Clear
                            </button>
                            <button
                                onClick={() => onImport(text)}
                                className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200"
                            >
                                Import Tasks
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskCard = ({ task, onEdit, onDelete, onStatusChange, onOpenColorPicker, onDropOnTask, settings }) => {
            // 4. Ensure Priority colors reflect accurately
            // generateDynamicStyles converts the hex codes in settings.priorityConfig to the style objects used here
            const priorityStyles = generateDynamicStyles(settings.priorityConfig);
            const weightStyles = generateDynamicStyles(settings.weightConfig);

            const priority = priorityStyles[task.priority] || priorityStyles['3'];
            const weight = weightStyles[task.weight || 'light'] || weightStyles['light'];

            // ... Color Resolution & Drag Handlers ...
            // Color Resolution
            let lineColorStyle = {};
            if (task.colorIndex !== undefined) {
                // New System: Use Custom Palette
                lineColorStyle = { backgroundColor: settings.palette[task.colorIndex] };
            } else if (task.lineColor) {
                // Legacy System: Use Class
                lineColorStyle = {}; // handled by className
            } else {
                // Default
                lineColorStyle = { backgroundColor: settings.palette[0] };
            }

            const handleDragStart = (e) => {
                e.dataTransfer.setData('taskId', task.id);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const droppedTaskId = e.dataTransfer.getData('taskId');
                if (droppedTaskId && droppedTaskId !== task.id) {
                onDropOnTask(droppedTaskId, task.id);
                }
            };

            // 5. Expiry Date Warning Check
            const getTargetDateColor = (targetDate, status) => {
                if (!targetDate || status === 'done' || status === 'cancel') return '';

                if (settings?.deadlineWarning?.enabled) {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const target = new Date(targetDate);
                    // Standardize target time for accurate comparison
                    target.setHours(0,0,0,0);

                    const warningDate = new Date(today);
                    warningDate.setDate(today.getDate() + settings.deadlineWarning.days);

                    // If target date is BEFORE or ON the warning threshold date (today + n days)
                    if (target <= warningDate) {
                        return 'text-red-600 font-bold';
                    }
                }
                return '';
            };

            const targetDateColor = getTargetDateColor(task.targetDate, task.status);
            const indentLevel = Math.min(task.level || 0, 9);
            const indentStyle = { marginLeft: `${indentLevel * 20}px` };

            let nameColorClass = "text-gray-800";
            if (settings?.ageWarning?.enabled && task.status !== 'done' && task.status !== 'cancel') {
                const age = calculateAge(task.createdAt);
                if (age > settings.ageWarning.days) {
                    nameColorClass = "text-red-600 font-bold";
                }
            }

            return (
                <div
                draggable
                onDragStart={handleDragStart}
                onDragOver={handleDragOver}
                onDrop={handleDrop}
                onClick={(e) => {
                    e.stopPropagation();
                    onEdit(task);
                }}
                style={indentStyle}
                className={`group bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all cursor-pointer mb-1 active:scale-95 select-none relative overflow-visible flex ${indentLevel > 0 ? 'mt-1 border-l-4 border-l-blue-100' : ''}`}
                >
                {indentLevel > 0 && (
                    <div className="absolute -left-3 top-3 text-gray-300">
                    <CornerDownRight size={12} />
                    </div>
                )}

                <div
                    className={`w-1.5 shrink-0 ${!task.colorIndex && task.lineColor ? task.lineColor : ''} ${indentLevel === 0 ? 'rounded-l-lg' : ''}`}
                    style={task.colorIndex !== undefined ? { backgroundColor: settings.palette[task.colorIndex] } : {}}
                ></div>

                <div className="p-3 flex-1 overflow-hidden relative">
                    <div className="flex justify-between items-start mb-2">
                    <div className="flex items-center gap-2">
                        {/* Priority Badge with Dynamic Style */}
                        <span
                            className="text-[10px] px-2 py-0.5 rounded-full font-medium flex items-center gap-1 border shadow-sm"
                            style={priority.styleObj}
                        >
                            <div className="w-1.5 h-1.5 rounded-full" style={priority.dotStyle}></div>
                            {priority.label}
                            {indentLevel > 0 && <span className="opacity-70 ml-1">L{indentLevel}</span>}
                        </span>

                        {/* Weight Badge with Dynamic Style */}
                        <span
                            className="text-[10px] px-2 py-0.5 rounded-full font-medium flex items-center gap-1 border shadow-sm"
                            style={weight.styleObj}
                        >
                            {weight.label}
                        </span>
                    </div>

                    <div className="flex gap-1 items-center relative z-[60]">
                        <div className="relative">
                            <button
                            onMouseDown={(e) => e.stopPropagation()}
                            onClick={(e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                onOpenColorPicker(task.id, 'line', e);
                            }}
                            className="p-1 hover:bg-gray-100 rounded-full text-gray-400 transition-all opacity-0 group-hover:opacity-100 z-30 relative"
                            title="Change Line Color"
                            >
                            <Palette size={12} />
                            </button>
                        </div>

                        {task.assignee && (
                        <div className="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600 border border-gray-200">
                            {task.assignee.substring(0, 2).toUpperCase()}
                        </div>
                        )}
                    </div>
                    </div>

                    <div className="flex items-center gap-2 mb-1">
                    <h4 className={`text-sm font-semibold ${nameColorClass} leading-snug truncate`}>
                        {task.type && <span className="text-gray-500 font-normal mr-1">[{task.type}]</span>}
                        {task.name}
                    </h4>
                    {task.externalRef && (
                        <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded flex items-center gap-0.5">
                        <ExternalLink size={8}/> {task.externalRef}
                        </span>
                    )}
                    </div>

                    {task.description && (
                    <div className="text-[10px] text-gray-600 mb-2 line-clamp-2 leading-relaxed">
                        {task.description}
                    </div>
                    )}

                    <div className="text-[10px] text-gray-500 mb-1 font-mono whitespace-nowrap overflow-hidden text-ellipsis flex items-center gap-2">
                    <span>C:{formatDate(task.createdAt)}</span>
                    <span>S:{formatDate(task.start)}</span>
                    <span className={`${targetDateColor}`}>T:{formatDate(task.targetDate)}</span>
                    {task.status === 'done' && <span className="text-green-600 font-bold">E:{formatDate(task.end)}</span>}
                    <span className="text-gray-400">| Age:{calculateAge(task.createdAt)}d</span>
                    {task.effort && <span className="text-blue-500">| Est:{task.effort}</span>}
                    </div>

                    <div className="flex gap-1 bg-white pl-2 absolute bottom-2 right-2 z-40 shadow-sm border border-gray-100 rounded-md p-0.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none group-hover:pointer-events-auto">
                    {(task.status === 'todo' || task.status === 'wip') && (
                        <>
                        <button
                            onMouseDown={(e) => e.stopPropagation()}
                            onClick={(e) => {
                            e.stopPropagation();
                            e.nativeEvent.stopImmediatePropagation();
                            e.preventDefault();
                            onStatusChange(task.id, 'done');
                            }}
                            className="p-1.5 hover:bg-green-100 text-green-600 rounded-md transition-colors" title="Complete"
                        >
                            <Check size={14} />
                        </button>
                        <button
                            onMouseDown={(e) => e.stopPropagation()}
                            onClick={(e) => {
                            e.stopPropagation();
                            e.nativeEvent.stopImmediatePropagation();
                            e.preventDefault();
                            onStatusChange(task.id, 'cancel');
                            }}
                            className="p-1.5 hover:bg-gray-100 text-gray-600 rounded-md transition-colors" title="Cancel"
                        >
                            <X size={14} />
                        </button>
                        </>
                    )}
                    {(task.status === 'done' || task.status === 'cancel') && (
                        <button
                        onMouseDown={(e) => e.stopPropagation()}
                        onClick={(e) => {
                            e.stopPropagation();
                            e.nativeEvent.stopImmediatePropagation();
                            e.preventDefault();
                            onStatusChange(task.id, 'todo');
                        }}
                        className="p-1.5 hover:bg-blue-100 text-blue-600 rounded-md transition-colors" title="Reopen"
                        >
                        <RotateCcw size={14} />
                        </button>
                    )}
                    <button
                        onMouseDown={(e) => e.stopPropagation()}
                        onClick={(e) => {
                        e.stopPropagation();
                        e.nativeEvent.stopImmediatePropagation();
                        e.preventDefault();
                        onDelete(task.id);
                        }}
                        className="p-1.5 hover:bg-red-100 text-red-600 rounded-md transition-colors" title="Delete"
                    >
                        <Trash2 size={14} />
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const KanbanColumn = ({ title, status, tasks, color, onDropTask, onEditTask, onDeleteTask, onStatusChange, onOpenColorPicker, projectId, onQuickAdd, onDropOnTask, isLast, settings }) => {
            const [isQuickAdding, setIsQuickAdding] = useState(false);
            const [qName, setQName] = useState('');
            const [qType, setQType] = useState('');
            const [qDescription, setQDescription] = useState('');
            const [qPIC, setQPIC] = useState('');
            const [qPriority, setQPriority] = useState('3');
            const [qWeight, setQWeight] = useState('light');
            const [qStart, setQStart] = useState(new Date().toISOString().split('T')[0]);
            const [qEffort, setQEffort] = useState('');
            const nameInputRef = useRef(null);

            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
            const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); const taskId = e.dataTransfer.getData('taskId'); if (taskId) onDropTask(taskId, status, projectId); };
            const handleBackgroundClick = (e) => {
                if (status === 'todo' && !isQuickAdding) {
                    if (e.target === e.currentTarget || e.target.classList.contains('min-h-[100px]')) {
                        setIsQuickAdding(true); setQName(''); setQType(''); setQDescription(''); setQPIC(''); setQPriority('3'); setQWeight('light'); setQStart(new Date().toISOString().split('T')[0]); setQEffort('');
                        setTimeout(() => nameInputRef.current?.focus(), 50);
                    }
                }
            };
            const handleQuickAddSubmit = () => {
                if (qName.trim()) {
                    onQuickAdd(projectId, { name: qName.trim(), type: qType.trim(), description: qDescription.trim(), pic: qPIC.trim(), priority: qPriority, weight: qWeight, start: qStart, effort: qEffort });
                    setQName(''); setQType(''); setQDescription(''); setQPIC(''); setQEffort(''); setIsQuickAdding(false);
                }
            };
            const handleCancelQuickAdd = () => { setIsQuickAdding(false); setQName(''); setQDescription(''); };

            const priorityStyles = generateDynamicStyles(settings.priorityConfig);
            const weightStyles = generateDynamicStyles(settings.weightConfig);

            return (
                <div
                className={`flex-1 min-w-[280px] flex flex-col h-full bg-white/40 backdrop-blur-sm transition-colors hover:bg-white/60 ${!isLast ? 'border-r border-gray-200' : ''}`}
                onDragOver={handleDragOver} onDrop={handleDrop} onClick={handleBackgroundClick}
                >
                <div className={`flex items-center justify-between p-2 rounded-t-lg border-b-2 ${color} bg-white/60`}>
                    <h3 className="font-bold text-gray-700 text-xs uppercase tracking-wide">{title}</h3>
                    <span className="bg-gray-200 text-gray-600 text-[10px] font-bold px-1.5 py-0.5 rounded-full">{tasks.length}</span>
                </div>

                <div className="flex-1 p-2 min-h-[100px] flex flex-col gap-0">
                    {tasks.map(task => (
                    <TaskCard key={task.id} task={task} onEdit={onEditTask} onDelete={onDeleteTask} onStatusChange={onStatusChange} onOpenColorPicker={onOpenColorPicker} onDropOnTask={onDropOnTask} settings={settings} />
                    ))}

                    {isQuickAdding && (
                    <div className="bg-white p-3 rounded-lg shadow-md border border-blue-400 mb-2 animate-in fade-in duration-200 flex flex-col gap-2" onClick={(e) => e.stopPropagation()}>
                        <div className="flex gap-2">
                            <input ref={nameInputRef} type="text" className="flex-[4] w-full text-sm font-semibold outline-none border-b border-gray-100 pb-1" placeholder="Task Name" value={qName} onChange={(e) => setQName(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); if(e.key === 'Escape') handleCancelQuickAdd(); }} />
                            <input type="text" className="flex-[1] w-full text-sm text-gray-500 outline-none border-b border-gray-100 pb-1" placeholder="Type" value={qType} onChange={(e) => setQType(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); }} />
                        </div>
                        <textarea className="w-full text-xs text-gray-600 outline-none border-b border-gray-100 pb-1 resize-none h-auto min-h-[1.5em]" placeholder="Description (optional)" rows={1} value={qDescription} onChange={(e) => setQDescription(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && e.ctrlKey) handleQuickAddSubmit(); if(e.key === 'Escape') handleCancelQuickAdd(); }} />

                        <div className="flex flex-wrap items-center gap-2 bg-gray-50 p-2 rounded border border-gray-100">
                        <div className="flex flex-col gap-1 border-r border-gray-200 pr-2">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Priority</label>
                            <div className="flex gap-1">
                            {Object.entries(priorityStyles).map(([key, config]) => (
                                <button key={key} type="button" onClick={() => setQPriority(key)}
                                style={config.styleObj}
                                className={`w-4 h-4 rounded-full flex items-center justify-center transition-all ${qPriority === key ? 'ring-1 ring-offset-1 ring-gray-400 scale-110' : 'opacity-60 hover:opacity-100'}`}
                                title={config.label} />
                            ))}
                            </div>
                        </div>
                        <div className="flex flex-col gap-1 border-r border-gray-200 pr-2">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Weight</label>
                            <div className="flex gap-1">
                            {Object.entries(weightStyles).map(([key, config]) => (
                                <button key={key} type="button" onClick={() => setQWeight(key)}
                                style={config.styleObj}
                                className={`w-4 h-4 rounded-full flex items-center justify-center transition-all ${qWeight === key ? 'ring-1 ring-offset-1 ring-gray-400 scale-110' : 'opacity-60 hover:opacity-100'}`}
                                title={config.label} />
                            ))}
                            </div>
                        </div>
                        <div className="flex-1 min-w-[60px] flex flex-col gap-1">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">PIC</label>
                            <div className="flex items-center gap-1">
                                <User size={12} className="text-gray-400"/>
                                <input type="text" className="w-full text-xs bg-transparent outline-none text-gray-700 border-b border-transparent focus:border-blue-300 placeholder-gray-300" placeholder="Name" value={qPIC} onChange={(e) => setQPIC(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); }} />
                            </div>
                        </div>
                        </div>

                        <div className="flex items-center gap-2">
                        <input type="date" className="text-xs bg-gray-50 border rounded p-1 w-24 shrink-0" value={qStart} onChange={(e) => setQStart(e.target.value)} />
                        <input type="text" className="flex-1 text-xs bg-gray-50 border rounded p-1 min-w-[60px]" placeholder="Effort" value={qEffort} onChange={(e) => setQEffort(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') handleQuickAddSubmit(); }} />
                        <button onClick={handleQuickAddSubmit} className="bg-blue-600 text-white rounded p-1 hover:bg-blue-700 shrink-0"><Plus size={16} /></button>
                        </div>
                    </div>
                    )}

                    {tasks.length === 0 && !isQuickAdding && (
                    <div className="h-full flex items-center justify-center text-gray-400 text-xs italic min-h-[80px] pointer-events-none">{status === 'todo' ? 'Click here to add task' : 'Empty'}</div>
                    )}
                </div>
                </div>
            );
        };

        const TaskModal = ({ isOpen, onClose, task, onSave, settings }) => {
            if (!isOpen) return null;
            const [formData, setFormData] = useState({ name: '', type: '', assignee: '', externalRef: '', refLinkType: 'J', priority: '3', weight: 'light', start: new Date().toISOString().split('T')[0], targetDate: '', effort: '', description: '', colorIndex: 0 }); // Added refLinkType default
            const [formOrder, setFormOrder] = useState(() => { const saved = localStorage.getItem('kanban_form_layout'); return saved ? JSON.parse(saved) : ['name', 'description', 'pic_ref', 'priority_weight', 'dates']; });
            const [draggedItem, setDraggedItem] = useState(null);

            useEffect(() => {
                if (task) {
                    setFormData({
                        name: task.name||'', type: task.type||'', assignee: task.assignee||'', externalRef: task.externalRef||'', refLinkType: task.refLinkType||'J', priority: task.priority||'3', weight: task.weight||'light', start: task.start||new Date().toISOString().split('T')[0], targetDate: task.targetDate||'', effort: task.effort||'', description: task.description||'',
                        colorIndex: task.colorIndex !== undefined ? task.colorIndex : 0
                    });
                } else {
                    setFormData({ name: '', type: '', assignee: '', externalRef: '', refLinkType: 'J', priority: '3', weight: 'light', start: new Date().toISOString().split('T')[0], targetDate: '', effort: '', description: '', colorIndex: 0 });
                }
            }, [task, isOpen]);

            useEffect(() => { if (formData.start && formData.effort) { const newTarget = getEndFromEffort(formData.start, formData.effort); setFormData(prev => ({ ...prev, targetDate: newTarget })); } }, [formData.start, formData.effort]);

            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); onClose(); };
            const onDragStart = (e, index) => { setDraggedItem(index); e.dataTransfer.effectAllowed = "move"; };
            const onDragOver = (e, index) => { e.preventDefault(); if (draggedItem === null || draggedItem === index) return; const newOrder = [...formOrder]; const item = newOrder.splice(draggedItem, 1)[0]; newOrder.splice(index, 0, item); setDraggedItem(index); setFormOrder(newOrder); };
            const onDragEnd = () => { setDraggedItem(null); localStorage.setItem('kanban_form_layout', JSON.stringify(formOrder)); };
            
            const handleOpenLink = () => {
                if (!formData.externalRef) return;
                let url = '';
                if (formData.refLinkType === 'J' && settings.jiraPath) {
                    url = settings.jiraPath + formData.externalRef;
                } else if (formData.refLinkType === 'C' && settings.confluencePath) {
                    url = settings.confluencePath + formData.externalRef;
                }
                
                if (url) {
                    window.open(url, '_blank');
                } else {
                    alert('Please configure the Jira or Confluence path in Settings first.');
                }
            };

            const priorityStyles = generateDynamicStyles(settings.priorityConfig);
            const weightStyles = generateDynamicStyles(settings.weightConfig);

            const renderField = (key) => {
                switch(key) {
                    case 'name': return (<div className="flex gap-4"><div className="flex-[4]"><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Task Name</label><input required type="text" className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="What needs to be done?" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/></div><div className="flex-[1]"><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Type</label><input type="text" className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Dev" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}/></div></div>);
                    case 'pic_ref': return (
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">PIC</label><div className="relative"><User size={14} className="absolute left-2.5 top-2.5 text-gray-400" /><input type="text" className="w-full pl-8 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Person In Charge" value={formData.assignee} onChange={e => setFormData({...formData, assignee: e.target.value})}/></div></div>
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">External Ref#</label>
                                <div className="flex gap-1">
                                    <select 
                                        className="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50 font-bold text-gray-700 w-14 shrink-0" 
                                        value={formData.refLinkType} 
                                        onChange={e => setFormData({...formData, refLinkType: e.target.value})}
                                    >
                                        <option value="J">J</option>
                                        <option value="C">C</option>
                                    </select>
                                    <input type="text" className="flex-1 min-w-0 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="e.g. JIRA-123" value={formData.externalRef} onChange={e => setFormData({...formData, externalRef: e.target.value})}/>
                                    <button 
                                        type="button"
                                        onClick={handleOpenLink}
                                        className="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-md transition-colors shrink-0"
                                        title="Open Link"
                                    >
                                        <ArrowRight size={14} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                    case 'priority_weight': return (
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100"><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Priority</label><div className="flex gap-2">
                                {Object.entries(priorityStyles).map(([key, config]) => (
                                    <button key={key} type="button" onClick={() => setFormData(prev => ({...prev, priority: key}))}
                                        className={`w-6 h-6 rounded-full flex items-center justify-center transition-all ${formData.priority === key ? 'ring-2 ring-offset-2 ring-gray-400 scale-110 shadow-sm' : 'opacity-60 hover:opacity-100'}`}
                                        style={config.styleObj}
                                        title={config.label}
                                    >
                                        {formData.priority === key && <div className="w-1.5 h-1.5 rounded-full" style={config.dotStyle} />}
                                    </button>
                                ))}
                            </div></div>
                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100"><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Weight</label><div className="flex gap-2">
                                {Object.entries(weightStyles).map(([key, config]) => (
                                    <button key={key} type="button" onClick={() => setFormData(prev => ({...prev, weight: key}))}
                                        className={`w-6 h-6 rounded-full flex items-center justify-center transition-all border border-gray-200 ${formData.weight === key ? 'ring-2 ring-offset-2 ring-gray-400 scale-110 shadow-sm' : 'opacity-60 hover:opacity-100'}`}
                                        style={config.styleObj}
                                        title={config.label}
                                    >
                                        {formData.weight === key && <Check size={10} style={{color: config.color}} />}
                                    </button>
                                ))}
                            </div></div>
                        </div>
                    );
                    case 'dates': return (<div className="grid grid-cols-3 gap-4"><div><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Start Date (S)</label><input type="date" className="w-full p-2 border rounded-md text-sm text-gray-600" value={formData.start} onChange={e => setFormData({...formData, start: e.target.value})}/></div><div><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Effort</label><input type="text" className="w-full p-2 border rounded-md text-sm text-gray-600 bg-white" placeholder="e.g. 2d, 1w" value={formData.effort} onChange={e => setFormData({...formData, effort: e.target.value})}/></div><div><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Target Date (T)</label><input type="date" className="w-full p-2 border rounded-md text-sm text-gray-600 bg-white" value={formData.targetDate} onChange={e => setFormData({...formData, targetDate: e.target.value})}/></div></div>);
                    case 'description': return (<div><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Description</label><textarea className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm h-24 resize-none" placeholder="Add details..." value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})}/></div>);
                    default: return null;
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                    <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                    <h3 className="font-bold text-gray-800">{task ? 'Edit Task' : 'New Task'}</h3>
                    <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition-colors"><X size={20} className="text-gray-500" /></button>
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 space-y-4 max-h-[80vh] overflow-y-auto">
                        {formOrder.map((key, index) => (<div key={key} draggable onDragStart={(e) => onDragStart(e, index)} onDragOver={(e) => onDragOver(e, index)} onDragEnd={onDragEnd} className={`transition-all ${draggedItem === index ? 'opacity-50 border-2 border-dashed border-blue-300 rounded-lg' : ''}`}><div className="flex items-center gap-2 mb-1 cursor-grab active:cursor-grabbing hover:bg-gray-50 rounded px-1 -ml-1 w-full group"><GripVertical size={12} className="text-gray-300 group-hover:text-gray-500 shrink-0"/><div className="flex-1 w-full">{renderField(key)}</div></div></div>))}
                        {(task && (task.status === 'done' || task.status === 'cancel')) && (<div className="mt-2"><label className="block text-xs font-semibold text-gray-500 uppercase mb-1 text-green-600">End Date (E)</label><input type="date" className="w-full p-2 border rounded-md text-sm text-gray-600 bg-white" value={formData.end || ''} onChange={e => setFormData({...formData, end: e.target.value})}/></div>)}
                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-blue-200 transition-all">{task ? 'Save Changes' : 'Create Task'}</button>
                    </form>
                </div></div>
            );
        };

        const ProjectModal = ({ isOpen, onClose, onSave, settings }) => {
            const [name, setName] = useState('');
            const [colorIndex, setColorIndex] = useState(0);
            const [iconName, setIconName] = useState('FolderKanban');

            if (!isOpen) return null;
            const handleSubmit = (e) => { e.preventDefault(); if (name.trim()) { onSave({ name, colorIndex, iconName }); setName(''); setColorIndex(0); setIconName('FolderKanban'); onClose(); } };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200"><div className="flex justify-between items-center p-4 border-b bg-gray-50"><h3 className="font-bold text-gray-800">New Project</h3><button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full transition-colors"><X size={20} className="text-gray-500" /></button></div>
                <form onSubmit={handleSubmit} className="p-4 space-y-4">
                    <div><label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Project Name</label><input required type="text" className="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="e.g. Marketing Launch" value={name} onChange={e => setName(e.target.value)} autoFocus /></div>

                    <div>
                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-2">Project Color</label>
                        <div className="grid grid-cols-5 gap-2">
                            {settings.palette.map((color, idx) => (
                                <button key={idx} type="button" onClick={() => setColorIndex(idx)} style={{backgroundColor: color}} className={`w-8 h-8 rounded-full border border-gray-200 ${colorIndex === idx ? 'ring-2 ring-black ring-offset-2' : ''}`} title={`Color ${idx + 1}`} />
                            ))}
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-2">Project Icon</label>
                        <div className="grid grid-cols-5 gap-2">
                            {Object.entries(ICONS).map(([key, Icon]) => (
                                <button key={key} type="button" onClick={() => setIconName(key)} className={`w-8 h-8 rounded-md flex items-center justify-center border border-gray-200 hover:bg-gray-50 ${iconName === key ? 'bg-gray-100 ring-2 ring-black ring-offset-1 text-blue-600' : 'text-gray-500'}`} title={key}>
                                    <Icon size={16} />
                                </button>
                            ))}
                        </div>
                    </div>

                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg shadow-blue-200 transition-all">Create Project</button>
                </form></div></div>
            );
        };

        // --- Main App Component ---

        function App() {
        const [currentView, setCurrentView] = useState('dashboard');
        // ... (state, effects, and actions are largely unchanged) ...
        const fileInputRef = useRef(null);
        const [zoomLevel, setZoomLevel] = useState(() => { try { const saved = localStorage.getItem('kanban_zoom_level'); return saved ? parseFloat(saved) : 1; } catch(e) { return 1; } });
        
        // Settings State
        const [settings, setSettings] = useState(() => {
            try {
                const saved = localStorage.getItem('kanban_settings_v30');
                let parsed = saved ? JSON.parse(saved) : {};

                // MIGRATION LOGIC: Ensure colors exist in configs
                const ensureColors = (config, defaultConf) => {
                    const newConf = { ...config };
                    if (!newConf || Object.keys(newConf).length === 0) return defaultConf;

                    Object.keys(newConf).forEach(key => {
                        if (!newConf[key].color) {
                            if (newConf[key].colorId && LEGACY_COLOR_MAP[newConf[key].colorId]) {
                                newConf[key].color = LEGACY_COLOR_MAP[newConf[key].colorId];
                            } else {
                                newConf[key].color = defaultConf[key]?.color || '#000000';
                            }
                        }
                    });
                    return newConf;
                };

                return {
                    darkMode: parsed.darkMode || false,
                    ageWarning: parsed.ageWarning || { enabled: false, days: 7 },
                    deadlineWarning: parsed.deadlineWarning || { enabled: false, days: 3 },
                    priorityConfig: ensureColors(parsed.priorityConfig, DEFAULT_PRIORITY_CONFIG),
                    weightConfig: ensureColors(parsed.weightConfig, DEFAULT_WEIGHT_CONFIG),
                    palette: parsed.palette || DEFAULT_PALETTE, // New Palette Settings
                    jiraPath: parsed.jiraPath || '', // New setting
                    confluencePath: parsed.confluencePath || '' // New setting
                };
            } catch (e) {
                console.error("Settings load error, resetting defaults", e);
                return { 
                    darkMode: false, 
                    ageWarning: { enabled: false, days: 7 }, 
                    deadlineWarning: { enabled: false, days: 3 }, 
                    priorityConfig: DEFAULT_PRIORITY_CONFIG, 
                    weightConfig: DEFAULT_WEIGHT_CONFIG, 
                    palette: DEFAULT_PALETTE,
                    jiraPath: '',
                    confluencePath: ''
                };
            }
        });

        // Dashboard Layout State
        const [dashboardLayout, setDashboardLayout] = useState(() => {
            try {
                const saved = localStorage.getItem('kanban_dashboard_layout');
                return saved ? JSON.parse(saved) : [
                    'projectSummary', 'teamWorkload', 'timeline', 'newTasks', 'completedTasks', 'delayedTasks', 'ongoingTasks'
                ];
            } catch (e) {
                return ['projectSummary', 'teamWorkload', 'timeline', 'newTasks', 'completedTasks', 'delayedTasks', 'ongoingTasks'];
            }
        });

        useEffect(() => {
            localStorage.setItem('kanban_dashboard_layout', JSON.stringify(dashboardLayout));
        }, [dashboardLayout]);

        // Drag State for Widgets - MOVED TO TOP LEVEL
        const [draggedWidget, setDraggedWidget] = useState(null);

        // Projects State
        const [projects, setProjects] = useState(() => { try { const saved = localStorage.getItem('kanban_data_v1'); return saved ? JSON.parse(saved) : [{ id: 'p1', name: 'Project Alpha', colorIndex: 0, icon: 'FolderKanban', tasks: [] }]; } catch (e) { return [{ id: 'p1', name: 'Project Alpha', colorIndex: 0, icon: 'FolderKanban', tasks: [] }]; } });

        // Load kanban.json on startup
        useEffect(() => {
            const loadExternalConfig = async () => {
                try {
                    const response = await fetch('kanban.json');
                    if (response.ok) {
                        const config = await response.json();
                        console.log('Loading configuration from kanban.json', config);
                        
                        if (config.settings) {
                            setSettings(prev => ({...prev, ...config.settings}));
                        }
                        if (config.projects && Array.isArray(config.projects)) {
                            setProjects(config.projects);
                        }
                    }
                } catch (error) {
                    // Silent failure expected if file doesn't exist or CORS blocks it (file:// protocol)
                    console.log('Could not auto-load kanban.json (this is normal for fresh installs or file:// protocol):', error);
                }
            };
            loadExternalConfig();
        }, []);

        useEffect(() => { localStorage.setItem('kanban_settings_v30', JSON.stringify(settings)); if (settings.darkMode) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); } }, [settings]);
        const updateSettings = (key, value) => { setSettings(prev => ({ ...prev, [key]: value })); };
        useEffect(() => { const handleWheel = (e) => { if (e.ctrlKey) { e.preventDefault(); setZoomLevel(prev => { let newZoom = prev - e.deltaY * 0.001; newZoom = Math.min(Math.max(0.5, newZoom), 2); return newZoom; }); } }; window.addEventListener('wheel', handleWheel, { passive: false }); return () => window.removeEventListener('wheel', handleWheel); }, []);
        useEffect(() => { localStorage.setItem('kanban_zoom_level', zoomLevel); document.documentElement.style.fontSize = `${16 * zoomLevel}px`; }, [zoomLevel]);
        
        const [activeProjectId, setActiveProjectId] = useState(null); const [searchQuery, setSearchQuery] = useState(''); const [collapsedProjects, setCollapsedProjects] = useState({}); const [isModalOpen, setIsModalOpen] = useState(false); const [isProjectModalOpen, setIsProjectModalOpen] = useState(false); const [editingTask, setEditingTask] = useState(null); const [activeColorPicker, setActiveColorPicker] = useState({ isOpen: false, type: 'line', targetId: null, position: { x: 0, y: 0 } });
        
        useEffect(() => { localStorage.setItem('kanban_data_v1', JSON.stringify(projects)); }, [projects]);
        
        const handleSaveConfig = () => {
            const configData = {
                settings: settings,
                projects: projects
            };
            const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kanban.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const handleAddProject = (projectData) => { const newProj = { id: generateId(), name: projectData.name, colorIndex: projectData.colorIndex, icon: projectData.iconName, tasks: [] }; setProjects(prev => [...prev, newProj]); setCurrentView('ongoing'); };
        const handleUpdateProjectColor = (projectId, newColorIndex) => { setProjects(prev => prev.map(p => p.id === projectId ? { ...p, colorIndex: newColorIndex } : p)); };
        const handleRenameProject = (projectId, newName) => { setProjects(prev => prev.map(p => p.id === projectId ? { ...p, name: newName } : p)); };
        const toggleProjectCollapse = (projectId) => { setCollapsedProjects(prev => ({ ...prev, [projectId]: !prev[projectId] })); };
        const toggleCollapseAll = () => { const allCollapsed = projects.every(p => collapsedProjects[p.id]); const newMap = {}; projects.forEach(p => newMap[p.id] = !allCollapsed); setCollapsedProjects(newMap); };
        const updateProject = (projectId, updater) => { setProjects(prev => prev.map(p => { if (p.id !== projectId) return p; return updater(p); })); };
        const deleteTask = (taskId) => { if (window.confirm("Are you sure you want to delete this task?")) { setProjects(prev => prev.map(p => ({ ...p, tasks: p.tasks.filter(t => t.id !== taskId) }))); } };
        const deleteProject = (projectId) => { if (confirm("Are you sure you want to delete this project and all its tasks?")) { setProjects(prev => prev.filter(p => p.id !== projectId)); } };
        const exportToCSV = (currentProjects) => { const headers = ['UUID', 'Project', 'Task Name', 'Type', 'External Ref', 'Ref Type', 'Status', 'Priority', 'Weight', 'Assignee', 'Start Date', 'End Date', 'Created Date', 'Completed Date', 'Effort', 'Level', 'Description', 'Line Color']; const rows = []; currentProjects.forEach(p => { p.tasks.forEach(t => { const safeName = (t.name || '').replace(/"/g, '""'); const safeDesc = (t.description || '').replace(/"/g, '""'); rows.push([`"${t.id}"`,`"${p.name}"`,`"${safeName}"`,`"${t.type || ''}"`,`"${t.externalRef||''}"`,`"${t.refLinkType||'J'}"`,t.status,t.priority,t.weight,`"${t.assignee || ''}"`,t.start,t.end||'',t.createdAt,t.completedAt||'',t.effort||'',t.level||0,`"${safeDesc}"`,t.lineColor||''].join(',')); }); }); const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + "\n" + rows.join('\n'); const encodedUri = encodeURI(csvContent); const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const dd = String(now.getDate()).padStart(2, '0'); const hh = String(now.getHours()).padStart(2, '0'); const min = String(now.getMinutes()).padStart(2, '0'); const fileName = `kanban_${yyyy}${mm}${dd}${hh}${min}.csv`; const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", fileName); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        const handlePlainTextImport = (jsonText) => { try { let importedTasks = []; const trimmedInput = jsonText.trim(); if (!trimmedInput) throw new Error("Input is empty"); if (trimmedInput.startsWith('[')) { importedTasks = JSON.parse(trimmedInput); } else { const lines = trimmedInput.split('\n').filter(line => line.trim() !== ''); if (lines.length < 2) throw new Error("Invalid CSV format"); const parseCSVLine = (line) => { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"') { inQuotes = !inQuotes; } else if (char === ',' && !inQuotes) { result.push(current); current = ''; } else { current += char; } } result.push(current); return result.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"')); }; const headers = parseCSVLine(lines[0]); for (let i = 1; i < lines.length; i++) { const values = parseCSVLine(lines[i]); const row = {}; headers.forEach((h, idx) => { if(values[idx] !== undefined) row[h] = values[idx]; }); importedTasks.push({ id: row['UUID'] || row['id'] || generateId(), name: row['Task Name'] || row['name'] || 'Untitled', project: row['Project'], type: row['Type'], externalRef: row['External Ref'], refLinkType: row['Ref Type'] || 'J', status: row['Status'] || 'todo', priority: row['Priority'] || '3', weight: row['Weight'] || 'light', assignee: row['Assignee'], start: row['Start Date'], end: row['End Date'], createdAt: row['Created Date'], completedAt: row['Completed Date'], effort: row['Effort'], level: parseInt(row['Level']) || 0, description: row['Description'], lineColor: row['Line Color'] }); } } if (!Array.isArray(importedTasks)) throw new Error("Input must be a JSON array or CSV"); const currentIds = new Set(projects.flatMap(p => p.tasks.map(t => t.id))); let targetProjects = [...projects]; if (targetProjects.length === 0) { targetProjects.push({ id: generateId(), name: 'Imported Project', colorIndex: 0, icon: 'FolderKanban', tasks: [] }); } let addedCount = 0; importedTasks.forEach(rawTask => { const checkId = rawTask.id || rawTask.ticketid; if (checkId && currentIds.has(checkId)) { return; } let projectId = null; if (rawTask.project) { const existingProj = targetProjects.find(p => p.name === rawTask.project); if (existingProj) { projectId = existingProj.id; } else { const newProjId = generateId(); targetProjects.push({ id: newProjId, name: rawTask.project, colorIndex: 0, icon: 'FolderKanban', tasks: [] }); projectId = newProjId; } } else if (rawTask.projectId) { const existingProj = targetProjects.find(p => p.id === rawTask.projectId); if (existingProj) projectId = existingProj.id; } if (!projectId) projectId = targetProjects[0].id; const newTask = { id: checkId || generateId(), name: rawTask.name || 'Untitled Task', status: rawTask.status || 'todo', type: rawTask.type || '', externalRef: rawTask.externalRef || '', refLinkType: rawTask.refLinkType || 'J', priority: rawTask.priority || '3', weight: rawTask.weight || 'light', assignee: rawTask.assignee || '', start: rawTask.start || new Date().toISOString().split('T')[0], end: rawTask.end || '', createdAt: rawTask.createdAt || new Date().toISOString(), completedAt: rawTask.completedAt, effort: rawTask.effort || '', level: rawTask.level || 0, description: rawTask.description || '', lineColor: rawTask.lineColor || 'bg-gray-400', projectId: projectId }; const pIndex = targetProjects.findIndex(p => p.id === projectId); if (pIndex > -1) { targetProjects[pIndex].tasks.push(newTask); addedCount++; } }); setProjects(targetProjects); alert(`Successfully imported ${addedCount} tasks.`); setCurrentView('ongoing'); } catch (e) { alert("Import Failed: " + e.message); console.error(e); } };
        const handleQuickAddTask = (projectId, taskData) => { if (!taskData.name || !projectId) return; const now = new Date().toISOString(); let calculatedTarget = ''; if (taskData.effort) { calculatedTarget = getEndFromEffort(taskData.start, taskData.effort); } updateProject(projectId, (project) => ({ ...project, tasks: [...project.tasks, { id: generateId(), status: 'todo', name: taskData.name, type: taskData.type, description: taskData.description || '', assignee: taskData.pic || '', priority: taskData.priority, weight: taskData.weight, start: taskData.start, effort: taskData.effort, targetDate: calculatedTarget, createdAt: now, projectId: projectId, lineColor: 'bg-gray-400', level: 0 }] })); };
        const handleSaveTask = (taskData) => { const targetProjectId = activeProjectId || projects[0]?.id; if (!targetProjectId) return; const now = new Date().toISOString(); updateProject(targetProjectId, (project) => { if (editingTask) { return { ...project, tasks: project.tasks.map(t => t.id === editingTask.id ? { ...t, ...taskData } : t) }; } else { return { ...project, tasks: [...project.tasks, { ...taskData, id: generateId(), status: 'todo', createdAt: now, projectId: targetProjectId, level: 0 }] }; } }); };
        const findDescendants = (allTasks, parentIndex, parentLevel) => { const descendants = []; for (let i = parentIndex + 1; i < allTasks.length; i++) { const currentTask = allTasks[i]; if ((currentTask.level || 0) > parentLevel) { descendants.push(currentTask); } else { break; } } return descendants; };
        const updateTaskStatus = (taskId, newStatus, targetProjectId) => { setProjects(prev => { let sourceProjectIndex = -1; let taskIndex = -1; let taskToMove = null; for (let i = 0; i < prev.length; i++) { const idx = prev[i].tasks.findIndex(t => t.id === taskId); if (idx !== -1) { sourceProjectIndex = i; taskIndex = idx; taskToMove = prev[i].tasks[idx]; break; } } if (!taskToMove) return prev; const newProjects = [...prev]; const now = new Date().toISOString(); const todayDate = now.split('T')[0]; const isDone = newStatus === 'done'; const projectTasks = newProjects[sourceProjectIndex].tasks; const descendants = findDescendants(projectTasks, taskIndex, taskToMove.level || 0); const idsToMove = [taskToMove.id, ...descendants.map(d => d.id)]; const currentRootLevel = taskToMove.level || 0; const levelShift = 0 - currentRootLevel; if (targetProjectId && targetProjectId !== newProjects[sourceProjectIndex].id) { const tasksToKeep = projectTasks.filter(t => !idsToMove.includes(t.id)); newProjects[sourceProjectIndex].tasks = tasksToKeep; const targetProj = newProjects.find(p => p.id === targetProjectId); if (targetProj) { idsToMove.forEach(id => { const t = (id === taskToMove.id) ? taskToMove : descendants.find(d => d.id === id); const oldLevel = t.level || 0; const newLevel = Math.max(0, oldLevel + levelShift); const updatedT = { ...t, status: newStatus, completedAt: isDone ? now : undefined, end: isDone ? todayDate : t.end, level: newLevel }; targetProj.tasks.push(updatedT); }); } } else { idsToMove.forEach(id => { const tIndex = projectTasks.findIndex(t => t.id === id); if (tIndex !== -1) { const oldLevel = projectTasks[tIndex].level || 0; const newLevel = Math.max(0, oldLevel + levelShift); projectTasks[tIndex] = { ...projectTasks[tIndex], status: newStatus, completedAt: isDone ? now : undefined, end: isDone ? todayDate : projectTasks[tIndex].end, level: newLevel }; } }); } return newProjects; }); };
        const handleDropOnTask = (droppedTaskId, targetTaskId) => { setProjects(prev => { let sourceProjectIndex = -1; let taskIndex = -1; let taskToMove = null; for (let i = 0; i < prev.length; i++) { const idx = prev[i].tasks.findIndex(t => t.id === droppedTaskId); if (idx !== -1) { sourceProjectIndex = i; taskIndex = idx; taskToMove = prev[i].tasks[idx]; break; } } if (!taskToMove) return prev; let targetProjectIndex = -1; let targetTaskIndex = -1; let targetTask = null; for (let i = 0; i < prev.length; i++) { const idx = prev[i].tasks.findIndex(t => t.id === targetTaskId); if (idx !== -1) { targetProjectIndex = i; targetTaskIndex = idx; targetTask = prev[i].tasks[idx]; break; } } if (!targetTask) return prev; if (sourceProjectIndex !== targetProjectIndex || taskToMove.status !== targetTask.status) { return prev; } const newProjects = [...prev]; const projectTasks = newProjects[sourceProjectIndex].tasks; projectTasks.splice(taskIndex, 1); const newLevel = Math.min((targetTask.level || 0) + 1, 9); const newTargetIndex = projectTasks.findIndex(t => t.id === targetTaskId); const updatedTask = { ...taskToMove, level: newLevel }; projectTasks.splice(newTargetIndex + 1, 0, updatedTask); return newProjects; }); };
        const updateTaskColor = (taskId, newColorIndex) => { setProjects(prev => prev.map(p => ({ ...p, tasks: p.tasks.map(t => t.id === taskId ? { ...t, colorIndex: newColorIndex } : t) }))); };
        const openNewTaskModal = (projectId) => { setActiveProjectId(projectId); setEditingTask(null); setIsModalOpen(true); };
        const openEditTaskModal = (task) => { const proj = projects.find(p => p.tasks.some(t => t.id === task.id)); if (proj) setActiveProjectId(proj.id); setEditingTask(task); setIsModalOpen(true); };
        const navigateToTask = (task) => { if (task.status === 'done' || task.status === 'cancel') { setCurrentView('completed'); } else { setCurrentView('ongoing'); } };
        const openColorPicker = (id, type, event) => { event.stopPropagation(); event.nativeEvent.stopImmediatePropagation(); const rect = event.currentTarget.getBoundingClientRect(); setActiveColorPicker({ isOpen: true, type, targetId: id, position: { x: rect.left, y: rect.bottom } }); };
        const handleColorSelect = (index) => { if (activeColorPicker.type === 'line') { updateTaskColor(activeColorPicker.targetId, index); } else { handleUpdateProjectColor(activeColorPicker.targetId, index); } setActiveColorPicker({ ...activeColorPicker, isOpen: false }); };
        const handleImportCSV = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { handlePlainTextImport(e.target.result); }; reader.readAsText(file); event.target.value = null; };

        // --- Dashboard Statistics ---
        const stats = useMemo(() => {
            let totalProjects = projects.length; let totalTodo = 0; let totalWip = 0; let totalCompleted = 0; let createdThisWeek = 0; let completedThisWeek = 0;
            const thisWeekStats = { todo: 0, wip: 0, done: 0 }; const lastWeekStats = { todo: 0, wip: 0, done: 0 };
            const assigneeTasks = {}; const projectCharts = [];
            const completedTasksProjects = []; const delayedTasksProjects = []; const newTasksProjects = []; const ongoingTasksProjects = [];
            const today = new Date(); const offset = today.getTimezoneOffset(); const todayLocal = new Date(today.getTime() - (offset*60*1000)); const todayStr = todayLocal.toISOString().split('T')[0];

            projects.forEach(p => {
                let pTodo = 0; let pWip = 0; let pDone = 0;
                const weeklyDoneTasks = []; const delayedTasks = []; const weeklyNewTasks = []; const ongoingTasks = [];
                p.tasks.forEach((t, index) => {
                    const isLeaf = isTaskLeaf(index, p.tasks);
                    if (!isLeaf) return;
                    if (t.status === 'todo') { totalTodo++; pTodo++; }
                    if (t.status === 'wip') { totalWip++; pWip++; }
                    if (t.status === 'done') { totalCompleted++; pDone++; }
                    if (t.status === 'wip') { ongoingTasks.push(t); }
                    if (isDateInCurrentWeek(t.createdAt)) { createdThisWeek++; weeklyNewTasks.push(t); if (t.status === 'todo') thisWeekStats.todo++; if (t.status === 'wip') thisWeekStats.wip++; }
                    if (t.status === 'done' && isDateInCurrentWeek(t.end)) { completedThisWeek++; weeklyDoneTasks.push(t); thisWeekStats.done++; }
                    if (isDateInLastWeek(t.createdAt)) { if (t.status === 'todo') lastWeekStats.todo++; if (t.status === 'wip') lastWeekStats.wip++; }
                    if (t.status === 'done' && isDateInLastWeek(t.end)) { lastWeekStats.done++; }
                    if (t.targetDate && t.targetDate < todayStr && (t.status === 'todo' || t.status === 'wip')) { delayedTasks.push(t); }
                    if (t.assignee) {
                        if (!assigneeTasks[t.assignee]) { assigneeTasks[t.assignee] = { totalTodo: [], totalWip: [], totalDone: [] }; }
                        const userStats = assigneeTasks[t.assignee];
                        if (t.status === 'todo') userStats.totalTodo.push(t);
                        if (t.status === 'wip') userStats.totalWip.push(t);
                        if (t.status === 'done') userStats.totalDone.push(t);
                    }
                });
                if (weeklyDoneTasks.length > 0) completedTasksProjects.push({ ...p, tasks: weeklyDoneTasks });
                if (delayedTasks.length > 0) delayedTasksProjects.push({ ...p, tasks: delayedTasks });
                if (weeklyNewTasks.length > 0) newTasksProjects.push({ ...p, tasks: weeklyNewTasks });
                if (ongoingTasks.length > 0) ongoingTasksProjects.push({ ...p, tasks: ongoingTasks });
                if (pTodo + pWip + pDone > 0) { projectCharts.push({ name: p.name, data: [ { label: 'Todo', value: pTodo, color: '#60a5fa' }, { label: 'WIP', value: pWip, color: '#fbbf24' }, { label: 'Done', value: pDone, color: '#4ade80' } ] }); }
            });
            return { totalProjects, totalTodo, totalWip, totalCompleted, createdThisWeek, completedThisWeek, thisWeekStats, lastWeekStats, assigneeTasks, projectCharts, completedTasksProjects, delayedTasksProjects, newTasksProjects, ongoingTasksProjects };
        }, [projects]);

        // Helper component for KPI Bars
        const KPIBar = ({ todo, wip, done, label }) => {
            const total = todo + wip + done;
            if (total === 0) return <div className="h-2 w-full bg-gray-100 rounded-full mt-2"></div>;
            const pTodo = (todo / total) * 100; const pWip = (wip / total) * 100; const pDone = (done / total) * 100;
            return ( <div className="w-full mt-2"><div className="flex h-2 w-full bg-gray-100 rounded-full overflow-hidden">{pTodo > 0 && <div style={{width: `${pTodo}%`}} className="bg-blue-400 h-full" title={`Todo: ${todo}`}></div>}{pWip > 0 && <div style={{width: `${pWip}%`}} className="bg-yellow-400 h-full" title={`WIP: ${wip}`}></div>}{pDone > 0 && <div style={{width: `${pDone}%`}} className="bg-green-400 h-full" title={`Completed: ${done}`}></div>}</div><div className="flex justify-between text-[10px] text-gray-400 mt-1"><span>{todo}</span><span>{wip}</span><span>{done}</span></div></div> );
        };

        const renderDashboard = () => {
            const priorityStyles = generateDynamicStyles(settings.priorityConfig);

            // Drag Handlers for Dashboard Widgets
            const handleWidgetDragStart = (e, index) => {
                setDraggedWidget(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleWidgetDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const handleWidgetDrop = (e, targetIndex) => {
                e.preventDefault();
                if (draggedWidget === null || draggedWidget === targetIndex) return;
                
                const newLayout = [...dashboardLayout];
                const widget = newLayout.splice(draggedWidget, 1)[0];
                newLayout.splice(targetIndex, 0, widget);
                
                setDashboardLayout(newLayout);
                setDraggedWidget(null);
            };

            // Drag Handlers for Dashboard Tasks
            const handleDashboardDragStart = (e, taskId) => {
                e.dataTransfer.setData('taskId', taskId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDashboardDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDashboardDrop = (e, newStatus) => {
                e.preventDefault();
                e.stopPropagation();
                const taskId = e.dataTransfer.getData('taskId');
                if (taskId) {
                    updateTaskStatus(taskId, newStatus);
                }
            };

            // Widget Renderers
            const renderWidgetContent = (widgetId) => {
                switch(widgetId) {
                    case 'projectSummary':
                        return (
                            <>
                                <h3 className="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2"><PieChart size={18}/> Project summary</h3>
                                {stats.projectCharts.length > 0 ? (<div className="grid grid-cols-1 sm:grid-cols-2 gap-6">{stats.projectCharts.map(pc => (<div key={pc.name} className="flex flex-col items-center p-4 bg-gray-50 rounded-lg border border-gray-200"><h4 className="font-semibold text-gray-700 mb-4 truncate w-full text-center" title={pc.name}>{pc.name}</h4><DonutChart data={pc.data} size={100} showLegend={false} /><div className="mt-4 w-full grid grid-cols-3 gap-1 text-[10px] text-center text-gray-500"><div className="bg-blue-100 py-1 rounded text-blue-700">T: {pc.data[0].value}</div><div className="bg-yellow-100 py-1 rounded text-yellow-700">W: {pc.data[1].value}</div><div className="bg-green-100 py-1 rounded text-green-700">D: {pc.data[2].value}</div></div></div>))}</div>) : (<div className="text-center py-10 text-gray-400 italic">No project data available</div>)}
                            </>
                        );
                    case 'teamWorkload':
                        return (
                            <>
                                <h3 className="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2"><User size={18}/> Distribution</h3>
                                {Object.keys(stats.assigneeTasks).length === 0 ? (<div className="flex h-40 items-center justify-center text-gray-400 italic">No active tasks assigned</div>) : (
                                    <div className="flex flex-col gap-4">
                                    {Object.entries(stats.assigneeTasks).map(([name, data]) => {
                                        const sortTasksByWeight = (taskList) => [...taskList].sort((a, b) => {
                                            const wa = a.weight || 'light';
                                            const wb = b.weight || 'light';
                                            const valA = wa === 'heavy' ? 3 : wa === 'medium' ? 2 : 1;
                                            const valB = wb === 'heavy' ? 3 : wb === 'medium' ? 2 : 1;
                                            return valB - valA;
                                        });
                                        const totalTodoSorted = sortTasksByWeight(data.totalTodo); const totalWipSorted = sortTasksByWeight(data.totalWip); const totalDoneSorted = sortTasksByWeight(data.totalDone);
                                        const activeScore = (data.totalTodo.length + data.totalWip.length);
                                        return { name, total: { todo: totalTodoSorted, wip: totalWipSorted, done: totalDoneSorted }, score: activeScore };
                                    }).sort((a, b) => b.score - a.score).slice(0, 8).map(({ name, total }) => {
                                        const InlineBar = ({ tasks, label }) => {
                                            const weightStyles = generateDynamicStyles(settings.weightConfig);
                                            return (<div className="flex flex-col flex-1 min-w-0"><div className="flex justify-between items-end mb-1"><span className="text-[10px] text-gray-400 uppercase">{label}</span><span className="text-[10px] font-bold text-gray-600">{tasks.length || 0}</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden flex w-full">{tasks.map(t => { const w = t.weight || 'light'; const widthClass = w === 'heavy' ? 'w-4' : w === 'medium' ? 'w-3' : 'w-1.5'; const style = weightStyles[w]?.styleObj?.backgroundColor ? { backgroundColor: weightStyles[w].styleObj.backgroundColor } : { backgroundColor: '#ccc'}; return <div key={t.id} className={`h-full border-r border-white/50 last:border-0 ${widthClass} shrink-0`} style={style} title={`${t.name} (${w})`}/> })}</div></div>)
                                        }
                                        return (<div key={name} className="bg-gray-50 p-3 rounded-lg border border-gray-100"><div className="flex items-center gap-3 mb-2"><div className="w-6 h-6 rounded-full bg-white flex items-center justify-center text-[10px] font-bold text-gray-600 border border-gray-200 shrink-0">{name.substring(0,2).toUpperCase()}</div><span className="font-bold text-sm text-gray-700">{name}</span></div><div className="flex gap-4"><InlineBar tasks={total.todo} label="Todo" /><InlineBar tasks={total.wip} label="WIP" /><InlineBar tasks={total.done} label="Comp" /></div></div>);
                                    })}</div>
                                )}
                            </>
                        );
                    case 'timeline':
                        return (
                            <>
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><Clock size={18} className="text-indigo-500"/> Timeline</h3></div>
                                <TimeChart tasks={projects.flatMap(p => p.tasks)} settings={settings} />
                            </>
                        );
                    case 'newTasks':
                        return (
                            <div onDragOver={handleDashboardDragOver} onDrop={(e) => handleDashboardDrop(e, 'todo')} className="h-full">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><Sparkles size={18} className="text-blue-500"/> New Tasks (this week)</h3></div>
                                {stats.newTasksProjects.length === 0 ? (<p className="text-gray-400 text-sm italic">No new tasks this week.</p>) : (
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="min-h-[100px] border-2 border-dashed border-transparent hover:border-blue-200 rounded-lg p-1 transition-colors" onDragOver={handleDashboardDragOver} onDrop={(e) => handleDashboardDrop(e, 'todo')}>
                                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500"></div> To Do</h4>
                                            {stats.newTasksProjects.map(p => {
                                                const tasks = p.tasks.filter(t => t.status === 'todo'); if (tasks.length === 0) return null;
                                                const projectColor = settings.palette[p.colorIndex || 0];
                                                return (<div key={p.id} className={`mb-4 pl-3 border-l-4`} style={{borderColor: projectColor}}><div className="text-xs font-bold text-gray-700 mb-1 flex items-center gap-1">{p.icon && ICONS[p.icon] && React.createElement(ICONS[p.icon], {size: 12})}{p.name}</div>{tasks.map(t => {
                                                    const pStyle = priorityStyles[t.priority] || priorityStyles['3'];
                                                    return (
                                                    <div key={t.id} draggable onDragStart={(e) => handleDashboardDragStart(e, t.id)} onClick={() => openEditTaskModal(t)} className="bg-gray-50 p-2 mb-1 rounded text-sm border border-gray-100 text-gray-600 hover:bg-blue-50 hover:border-blue-200 cursor-pointer transition-colors flex items-center justify-between gap-2 active:cursor-grabbing">
                                                        <div className="truncate font-medium text-gray-700 leading-tight">{t.type && <span className="text-gray-500 mr-1 text-[10px]">[{t.type}]</span>}{t.name}</div>
                                                        <div className="flex items-center gap-2 shrink-0"><span className="text-[8px] px-1 py-0 rounded-full border font-bold uppercase" style={pStyle.styleObj}>{pStyle.label}</span>{t.targetDate && <span className="text-[10px] text-gray-400 font-mono">T:{formatDate(t.targetDate)}</span>}</div>
                                                    </div>)})}</div>)
                                            })}
                                        </div>
                                        <div className="min-h-[100px] border-2 border-dashed border-transparent hover:border-yellow-200 rounded-lg p-1 transition-colors" onDragOver={handleDashboardDragOver} onDrop={(e) => handleDashboardDrop(e, 'wip')}>
                                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-yellow-500"></div> In Progress</h4>
                                            {stats.newTasksProjects.map(p => {
                                                const tasks = p.tasks.filter(t => t.status === 'wip'); if (tasks.length === 0) return null;
                                                const projectColor = settings.palette[p.colorIndex || 0];
                                                return (<div key={p.id} className={`mb-4 pl-3 border-l-4`} style={{borderColor: projectColor}}><div className="text-xs font-bold text-gray-700 mb-1 flex items-center gap-1">{p.icon && ICONS[p.icon] && React.createElement(ICONS[p.icon], {size: 12})}{p.name}</div>{tasks.map(t => {
                                                    const pStyle = priorityStyles[t.priority] || priorityStyles['3'];
                                                    return (
                                                    <div key={t.id} draggable onDragStart={(e) => handleDashboardDragStart(e, t.id)} onClick={() => openEditTaskModal(t)} className="bg-gray-50 p-2 mb-1 rounded text-sm border border-gray-100 text-gray-600 hover:bg-blue-50 hover:border-blue-200 cursor-pointer transition-colors flex items-center justify-between gap-2 active:cursor-grabbing">
                                                        <div className="truncate font-medium text-gray-700 leading-tight">{t.type && <span className="text-gray-500 mr-1 text-[10px]">[{t.type}]</span>}{t.name}</div>
                                                        <div className="flex items-center gap-2 shrink-0"><span className="text-[8px] px-1 py-0 rounded-full border font-bold uppercase" style={pStyle.styleObj}>{pStyle.label}</span>{t.targetDate && <span className="text-[10px] text-gray-400 font-mono">T:{formatDate(t.targetDate)}</span>}</div>
                                                    </div>)})}</div>)
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    case 'completedTasks':
                        return (
                            <div onDragOver={handleDashboardDragOver} onDrop={(e) => handleDashboardDrop(e, 'done')} className="h-full">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><CheckCircle2 size={18} /> Completed Tasks (This week)</h3></div>
                                {stats.completedTasksProjects.length === 0 ? (<p className="text-gray-400 text-sm italic">No tasks completed this week.</p>) : (
                                    <div>{stats.completedTasksProjects.map(p => {
                                        const projectColor = settings.palette[p.colorIndex || 0];
                                        return (<div key={p.id} className={`mb-4 pl-3 border-l-4`} style={{borderColor: projectColor}}><div className="text-xs font-bold text-gray-700 mb-1 flex items-center gap-1">{p.icon && ICONS[p.icon] && React.createElement(ICONS[p.icon], {size: 12})}{p.name}</div>{p.tasks.map(t => {
                                            const pStyle = priorityStyles[t.priority] || priorityStyles['3'];
                                            return (
                                            <div key={t.id} draggable onDragStart={(e) => handleDashboardDragStart(e, t.id)} onClick={() => openEditTaskModal(t)} className="bg-gray-50 p-2 mb-1 rounded text-sm border border-gray-100 text-gray-600 hover:bg-blue-50 hover:border-blue-200 cursor-pointer transition-colors flex items-center justify-between gap-2 active:cursor-grabbing">
                                                <div className="truncate font-medium text-gray-700 leading-tight">{t.type && <span className="text-gray-500 mr-1 text-[10px]">[{t.type}]</span>}{t.name}</div>
                                                <div className="flex items-center gap-2 shrink-0"><span className="text-[8px] px-1 py-0 rounded-full border font-bold uppercase" style={pStyle.styleObj}>{pStyle.label}</span><span className="text-[10px] text-gray-400 font-mono">E:{formatDate(t.end)}</span>{t.targetDate && <span className="text-[10px] text-gray-400 font-mono">T:{formatDate(t.targetDate)}</span>}</div>
                                            </div>)})}</div>)
                                    })}</div>
                                )}
                            </div>
                        );
                    case 'delayedTasks':
                        return (
                            <div className="h-full">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><AlertCircle size={18} className="text-red-500"/> Delayed Tasks</h3></div>
                                {stats.delayedTasksProjects.length === 0 ? (<p className="text-gray-400 text-sm italic">No tasks delayed.</p>) : (
                                    <div className="space-y-4">{stats.delayedTasksProjects.map(p => (renderProjectRow(p, [{ title: 'Delayed', status: 'delayed', statuses: ['todo', 'wip'] }])))}</div>
                                )}
                            </div>
                        );
                    case 'ongoingTasks':
                        return (
                            <div onDragOver={handleDashboardDragOver} onDrop={(e) => handleDashboardDrop(e, 'wip')} className="h-full">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><Activity size={18} className="text-yellow-500"/> Ongoing Tasks</h3></div>
                                {stats.ongoingTasksProjects.length === 0 ? (<p className="text-gray-400 text-sm italic">No active tasks in progress.</p>) : (
                                    <div>{stats.ongoingTasksProjects.map(p => {
                                        const projectColor = settings.palette[p.colorIndex || 0];
                                        return (<div key={p.id} className={`mb-4 pl-3 border-l-4`} style={{borderColor: projectColor}}><div className="text-xs font-bold text-gray-700 mb-1 flex items-center gap-1">{p.icon && ICONS[p.icon] && React.createElement(ICONS[p.icon], {size: 12})}{p.name}</div>{p.tasks.map(t => {
                                            const pStyle = priorityStyles[t.priority] || priorityStyles['3'];
                                            return (
                                            <div key={t.id} draggable onDragStart={(e) => handleDashboardDragStart(e, t.id)} onClick={() => openEditTaskModal(t)} className="bg-gray-50 p-2 mb-1 rounded text-sm border border-gray-100 text-gray-600 hover:bg-blue-50 hover:border-blue-200 cursor-pointer transition-colors flex items-center justify-between gap-2 active:cursor-grabbing">
                                                <div className="truncate font-medium text-gray-700 leading-tight">{t.type && <span className="text-gray-500 mr-1 text-[10px]">[{t.type}]</span>}{t.name}</div>
                                                <div className="flex items-center gap-2 shrink-0"><span className="text-[8px] px-1 py-0 rounded-full border font-bold uppercase" style={pStyle.styleObj}>{pStyle.label}</span>{t.targetDate && <span className="text-[10px] text-gray-400 font-mono">T:{formatDate(t.targetDate)}</span>}</div>
                                            </div>)})}</div>)
                                    })}</div>
                                )}
                            </div>
                        );
                    default: return null;
                }
            };

            return (
            <div className="p-8 max-w-7xl mx-auto space-y-8 animate-in fade-in duration-500 overflow-y-auto h-full">

            {/* Row 1: KPI Compact (Fixed) */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex items-center justify-between"><div><p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Projects</p><h3 className="text-2xl font-black text-gray-800">{stats.totalProjects}</h3></div><div className="p-2 rounded-full bg-indigo-50 text-indigo-500"><Layers size={20}/></div></div>
                <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-center"><div className="flex justify-between items-end"><p className="text-xs text-gray-500 font-bold uppercase tracking-wider">This week</p><span className="text-[10px] text-gray-400">(Active/Completed)</span></div><KPIBar todo={stats.thisWeekStats.todo} wip={stats.thisWeekStats.wip} done={stats.thisWeekStats.done} /></div>
                <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-center"><div className="flex justify-between items-end"><p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Last Week</p><span className="text-[10px] text-gray-400">(Active/Completed)</span></div><KPIBar todo={stats.lastWeekStats.todo} wip={stats.lastWeekStats.wip} done={stats.lastWeekStats.done} /></div>
                <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-center"><div className="flex justify-between items-end"><p className="text-xs text-gray-500 font-bold uppercase tracking-wider">TOTAL</p><span className="text-[10px] text-gray-400">TODO/WIP/Done</span></div><KPIBar todo={stats.totalTodo} wip={stats.totalWip} done={stats.totalCompleted} /></div>
            </div>

            {/* Moveable Dashboard Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                {dashboardLayout.map((widgetId, index) => {
                    const isFullWidth = widgetId === 'timeline';
                    return (
                        <div
                            key={widgetId}
                            draggable
                            onDragStart={(e) => handleWidgetDragStart(e, index)}
                            onDragOver={(e) => handleWidgetDragOver(e, index)}
                            onDrop={(e) => handleWidgetDrop(e, index)}
                            className={`bg-white p-6 rounded-xl shadow-sm border border-gray-100 transition-all ${isFullWidth ? 'lg:col-span-2' : 'lg:col-span-1'} ${draggedWidget === index ? 'opacity-50 scale-95 border-dashed border-2 border-blue-300' : ''} group relative`}
                        >
                            {/* Drag Handle Icon - Visible on hover */}
                            <div className="absolute top-2 right-2 p-1 text-gray-300 opacity-0 group-hover:opacity-100 widget-drag-handle cursor-grab active:cursor-grabbing hover:bg-gray-50 rounded">
                                <Move size={14} />
                            </div>
                            {renderWidgetContent(widgetId)}
                        </div>
                    );
                })}
            </div>

            </div>
            );
        };

        const renderProjectRow = (project, columns) => {
            const todoCount = project.tasks.filter(t => t.status === 'todo' && isTaskLeaf(project.tasks.indexOf(t), project.tasks)).length;
            const wipCount = project.tasks.filter(t => t.status === 'wip' && isTaskLeaf(project.tasks.indexOf(t), project.tasks)).length;
            const doneCount = project.tasks.filter(t => t.status === 'done' && isTaskLeaf(project.tasks.indexOf(t), project.tasks)).length;

            // Stats for summary row
            const urgentCount = project.tasks.filter(t => t.priority === '1' && (t.status === 'todo' || t.status === 'wip')).length;
            const highCount = project.tasks.filter(t => t.priority === '2' && (t.status === 'todo' || t.status === 'wip')).length;
            const normalCount = project.tasks.filter(t => t.priority === '3' && (t.status === 'todo' || t.status === 'wip')).length;
            const lowCount = project.tasks.filter(t => t.priority === '4' && (t.status === 'todo' || t.status === 'wip')).length;

            const heavyCount = project.tasks.filter(t => t.weight === 'heavy' && (t.status === 'todo' || t.status === 'wip')).length;
            const mediumCount = project.tasks.filter(t => t.weight === 'medium' && (t.status === 'todo' || t.status === 'wip')).length;
            const lightCount = project.tasks.filter(t => (t.weight === 'light' || !t.weight) && (t.status === 'todo' || t.status === 'wip')).length;

            const isMainBoard = currentView === 'ongoing' || currentView === 'completed';
            const isCollapsed = collapsedProjects[project.id] && isMainBoard;

            const gridClass = isMainBoard
                ? `grid grid-cols-${columns.length} divide-x divide-gray-200`
                : 'grid grid-cols-1';

            // Resolve Project Color and Contrast
            const projectColor = settings.palette[project.colorIndex || 0];
            const projectContrast = getContrastColor(projectColor);

            // Determine Project Border Color (Exact)
            let borderColorStyle = { borderColor: projectColor };

            // Project Background tint (Keep faint tint for body to differentiate form white cards)
            const bgStyle = {
                backgroundColor: hexToRgba(projectColor, 0.03) // Very subtle tint for body
            };

            // Project Drag and Drop logic
            const handleProjectDragStart = (e, id) => {
                e.dataTransfer.setData('projectId', id);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleProjectDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleProjectDrop = (e, targetProjectId) => {
                e.preventDefault();
                e.stopPropagation();
                const sourceProjectId = e.dataTransfer.getData('projectId');
                if (sourceProjectId && sourceProjectId !== targetProjectId) {
                    setProjects(prev => {
                        const sourceIndex = prev.findIndex(p => p.id === sourceProjectId);
                        const targetIndex = prev.findIndex(p => p.id === targetProjectId);
                        if (sourceIndex === -1 || targetIndex === -1) return prev;

                        const newProjects = [...prev];
                        const [removed] = newProjects.splice(sourceIndex, 1);
                        newProjects.splice(targetIndex, 0, removed);
                        return newProjects;
                    });
                }
            };

            // Icon Resolver
            const ProjectIcon = ICONS[project.icon] || FolderKanban;

            return (
            <div
                key={project.id}
                className={`rounded-xl shadow-sm border border-gray-200 mb-4 ${!isMainBoard ? `border-l-4` : ''}`}
                style={{ ...bgStyle, ...(!isMainBoard ? borderColorStyle : {}) }}
                draggable={isMainBoard}
                onDragStart={(e) => handleProjectDragStart(e, project.id)}
                onDragOver={handleProjectDragOver}
                onDrop={(e) => handleProjectDrop(e, project.id)}
            >
                <div
                    className="p-4 border-b border-black/5 flex justify-between items-center group rounded-t-xl relative z-[10]"
                    style={{ backgroundColor: projectColor, color: projectContrast }}
                >
                <div className="flex items-center gap-3">
                    {isMainBoard && (
                        <div className="cursor-grab active:cursor-grabbing opacity-60 hover:opacity-100">
                            <GripVertical size={16} />
                        </div>
                    )}
                    {isMainBoard && (
                        <button
                            onClick={(e) => { e.stopPropagation(); toggleProjectCollapse(project.id); }}
                            className="opacity-60 hover:opacity-100 transition-colors"
                        >
                            {isCollapsed ? <ChevronRight size={18} /> : <ChevronDown size={18} />}
                        </button>
                    )}
                    <h3 className="font-bold flex items-center gap-2">
                        <ProjectIcon size={18} style={{ color: projectContrast }}/>
                        {/* Inline Rename */}
                        <input
                            type="text"
                            value={project.name}
                            onChange={(e) => handleRenameProject(project.id, e.target.value)}
                            className="bg-transparent border-none outline-none focus:ring-1 focus:ring-current rounded px-1 hover:bg-white/10 w-full max-w-[300px]"
                            style={{ color: projectContrast }}
                        />
                    </h3>
                    {isMainBoard && (
                        <div className="text-xs font-medium flex gap-2 ml-4 bg-white/20 px-2 py-1 rounded-md border border-white/10 items-center overflow-x-auto no-scrollbar max-w-[50vw]" style={{ color: projectContrast }}>
                        {currentView === 'ongoing' ? (
                            <>
                                <span className="whitespace-nowrap">TODO: {todoCount}</span>
                                <span className="opacity-50">|</span>
                                <span className="whitespace-nowrap">WIP: {wipCount}</span>
                                {isCollapsed && (
                                    <>
                                        <span className="opacity-50">|</span>
                                        <span className="whitespace-nowrap">High: {urgentCount + highCount}</span>
                                    </>
                                )}
                            </>
                        ) : (
                            <span>Completed: {doneCount}</span>
                        )}
                        </div>
                    )}

                    {isMainBoard && (
                        <div className="relative">
                        <button
                            onClick={(e) => {
                            e.stopPropagation();
                            // Use unified palette index picker
                            openColorPicker(project.id, 'bg', e);
                            }}
                            className="p-1.5 rounded-full opacity-60 hover:bg-white/20 hover:opacity-100 transition-all"
                            title="Project Color"
                        >
                            <Palette size={14} />
                        </button>
                        </div>
                    )}
                </div>

                {isMainBoard && (
                    <div className="flex items-center gap-2">
                    <button
                        onClick={() => openNewTaskModal(project.id)}
                        className="text-xs bg-white/20 hover:bg-white/30 border border-white/20 px-3 py-1.5 rounded-md transition-all flex items-center gap-1 font-medium"
                        style={{ color: projectContrast }}
                    >
                        <Plus size={14} /> Add Task
                    </button>
                    <button
                        onClick={(e) => {
                            e.stopPropagation();
                            deleteProject(project.id);
                        }}
                        className="p-1.5 hover:bg-red-500/20 rounded-md transition-all opacity-60 hover:opacity-100"
                        title="Delete Project"
                        style={{ color: projectContrast }}
                    >
                        <Trash2 size={14} />
                    </button>
                    </div>
                )}
                </div>

                {!isCollapsed && (
                    <div className={gridClass}>
                    {columns.map((col, idx) => (
                        <div key={idx} className={`p-4 ${idx % 2 === 0 ? 'bg-white/40' : 'bg-white/10'}`}>
                        <div className="min-h-[50px]">
                            <KanbanColumn
                            title={col.title}
                            status={col.status}
                            color="hidden"
                            tasks={project.tasks.filter(t => {
                                let match = false;
                                if (col.status === 'delayed') {
                                    match = true;
                                } else {
                                    match = col.statuses.includes(t.status);
                                }
                                if (match && searchQuery) {
                                    match = t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                            (t.assignee && t.assignee.toLowerCase().includes(searchQuery.toLowerCase()));
                                }
                                return match;
                            })}
                            onDropTask={updateTaskStatus}
                            onEditTask={isMainBoard ? openEditTaskModal : navigateToTask}
                            onDeleteTask={deleteTask}
                            onStatusChange={updateTaskStatus}
                            onColorChange={updateTaskColor} // Not strictly used by child but consistent props
                            onOpenColorPicker={openColorPicker}
                            projectId={project.id}
                            onQuickAdd={handleQuickAddTask}
                            onDropOnTask={handleDropOnTask}
                            isLast={idx === columns.length - 1}
                            settings={settings} // Pass settings
                            />
                        </div>
                        </div>
                    ))}
                    </div>
                )}
            </div>
            );
        };

        return (
            <div className={`flex flex-col h-screen w-full bg-gray-50 font-sans text-gray-900 ${settings.darkMode ? 'dark' : ''}`}>
            <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-20 shrink-0">
                <div className="flex items-center gap-8">
                <h1 className="text-xl font-black text-gray-800 tracking-wider flex items-center gap-2">
                    Kanban Board v30
                </h1>

                <nav className="flex gap-1 bg-gray-100/50 p-1 rounded-lg">
                    <button
                    onClick={() => setCurrentView('dashboard')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <LayoutDashboard size={16} /> Dashboard
                    </button>
                    <button
                    onClick={() => setCurrentView('ongoing')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'ongoing' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <KanbanSquare size={16} /> Ongoing
                    </button>
                    <button
                    onClick={() => setCurrentView('completed')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'completed' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <Check size={16} /> Completed
                    </button>
                    {/* New Tabs */}
                    <button
                    onClick={() => setCurrentView('import')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'import' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <Upload size={16} /> Import
                    </button>
                    <button
                    onClick={() => setCurrentView('settings')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${currentView === 'settings' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200/50'}`}
                    >
                    <Settings size={16} /> Setting
                    </button>
                </nav>
                </div>

                <div className="flex items-center gap-4">
                <div className="relative hidden md:block">
                    <Search size={16} className="absolute left-3 top-2.5 text-gray-400" />
                    <input
                    type="text"
                    placeholder="Search tasks..."
                    className="pl-9 pr-4 py-2 bg-gray-100 rounded-full text-xs focus:bg-white focus:ring-2 focus:ring-blue-100 border border-transparent focus:border-blue-200 outline-none transition-all w-48"
                    value={searchQuery}
                    onChange={e => setSearchQuery(e.target.value)}
                    />
                </div>

                <div className="h-6 w-px bg-gray-200 mx-1"></div>

                {/* Import/Export */}
                <div className="flex items-center gap-2">
                    <input
                    type="file"
                    accept=".csv"
                    className="hidden"
                    ref={fileInputRef}
                    onChange={(e) => handleImportCSV(e)}
                    />
                    <div className="flex bg-gray-100 rounded-lg p-1">
                    <button
                        onClick={() => exportToCSV(projects)}
                        className="p-1.5 hover:bg-white rounded-md text-gray-500 hover:text-blue-600 transition-all shadow-sm"
                        title="Export CSV"
                    >
                        <Download size={16} />
                    </button>
                    <button
                        onClick={() => fileInputRef.current?.click()}
                        className="p-1.5 hover:bg-white rounded-md text-gray-500 hover:text-blue-600 transition-all shadow-sm"
                        title="Import CSV"
                    >
                        <Upload size={16} />
                    </button>
                    </div>

                    <button
                    onClick={() => setIsProjectModalOpen(true)}
                    className="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all"
                    title="Add New Project"
                    >
                    <Plus size={16} /> <span className="hidden lg:inline">Project</span>
                    </button>
                </div>
                </div>
            </header>

            <main className="flex-1 overflow-hidden bg-gray-50 relative" onClick={() => setActiveColorPicker({ ...activeColorPicker, isOpen: false })}>
                {currentView === 'dashboard' && renderDashboard()}
                {currentView === 'import' && <ImportView onImport={handlePlainTextImport} />}
                {currentView === 'settings' && <SettingsView settings={settings} onUpdateSettings={updateSettings} onSaveConfig={handleSaveConfig} />}

                {currentView === 'ongoing' && (
                <div className="h-full overflow-y-auto p-6 space-y-8">
                    <div className="flex justify-between items-center mb-2 px-4">
                        {/* ALIGNMENT FIX: Added ml-4 and border-l-4 border-transparent to match Project Row Indent */}
                        <div className="grid grid-cols-2 divide-x divide-transparent w-full border-l-4 border-transparent ml-4">
                            <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2 pl-4"><div className="w-2 h-2 rounded-full bg-blue-500"></div> To Do</h4>
                            <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2 pl-4"><div className="w-2 h-2 rounded-full bg-yellow-500"></div> In Progress</h4>
                        </div>
                        {/* Global Collapse Toggle */}
                        <button onClick={toggleCollapseAll} className="ml-4 text-xs font-bold text-blue-600 hover:text-blue-800 whitespace-nowrap">
                            Collapse / Expand All
                        </button>
                    </div>
                    {projects.map(project => {
                    const hasMatchingTasks = project.tasks.some(t =>
                        t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        (t.assignee && t.assignee.toLowerCase().includes(searchQuery.toLowerCase()))
                    );
                    if (searchQuery && !hasMatchingTasks) return null;

                    return renderProjectRow(project, [
                        { title: '', status: 'todo', statuses: ['todo'] },
                        { title: '', status: 'wip', statuses: ['wip'] }
                    ]);
                    })}

                    {projects.length === 0 && (
                    <div className="text-center py-20 text-gray-400">
                        <p>No projects found. Click "+ Project" to start.</p>
                    </div>
                    )}
                </div>
                )}

                {currentView === 'completed' && (
                <div className="h-full overflow-y-auto p-6 space-y-8">
                    <div className="grid grid-cols-2 gap-4 mb-2 px-4 border-l-4 border-transparent ml-4">
                        <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-500"></div> Completed</h4>
                        <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500"></div> Cancelled</h4>
                    </div>
                    {projects.map(project => {
                    const hasCompleted = project.tasks.some(t => t.status === 'done' || t.status === 'cancel');
                    if (!hasCompleted) return null;

                    return renderProjectRow(project, [
                        { title: '', status: 'done', statuses: ['done'] },
                        { title: '', status: 'cancel', statuses: ['cancel'] }
                    ]);
                    })}
                </div>
                )}
            </main>

            <div className="fixed bottom-2 right-2 text-[10px] text-gray-300">v30.0</div>

            {/* GLOBAL COLOR PICKER: This lives at the root level, outside any overflow/clip containers */}
            {activeColorPicker.isOpen && (
                <GlobalColorPicker
                    position={activeColorPicker.position}
                    type={activeColorPicker.type}
                    palette={settings.palette}
                    onSelect={handleColorSelect}
                    onClose={() => setActiveColorPicker({ ...activeColorPicker, isOpen: false })}
                />
            )}

            <TaskModal
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                task={editingTask}
                onSave={handleSaveTask}
                settings={settings}
            />

            <ProjectModal
                isOpen={isProjectModalOpen}
                onClose={() => setIsProjectModalOpen(false)}
                onSave={handleAddProject}
                settings={settings}
            />
            </div>
        );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
